- name: Kube 07 Haproxy keepalived
  hosts: k8s_controller
  strategy: free
  become: yes
  vars_files:
    - vars_kube.yaml

  tasks:
    - name: HAproxy and Keepalived group
      ansible.builtin.group:
        name: "{{item}}"
      with_items:
      - haproxy
      - keepalived
      - keepalived_script

    - name: HAproxy and Keepalived users
      ansible.builtin.user:
        name: "{{item}}"
        group: "{{item}}"
        system: true
        shell: /usr/bin/false
      with_items:
      - haproxy
      - keepalived
      - keepalived_script

    # Make variables for the Kubernetes configfile
    - name: Get IP for a subset of hosts, store in PEERS_IP
      ansible.builtin.shell:
        cmd: ip route | awk '(/default/){print $5}'
      register: iface

    - name: Get IP for all hosts, store in HOST_IP
      ansible.builtin.set_fact:
        APISERVER_IP: "{{ lookup('community.general.dig', APISERVER) }}"

    - name: Get IP for a subset of hosts, store in HOST_IP
      ansible.builtin.set_fact:
        HOST_IP: "{{ HOST_IP | combine({ item: lookup('community.general.dig', item) }) }}"
      loop: "{{ groups['k8s_controller'] }}"

    - name: haproxy + keepalive
      block:
        - name: config
          ansible.builtin.file:
            path: "/etc/{{item}}"
            state: directory
            mode: 0755
            owner: haproxy
            group: haproxy
          with_items:
            - haproxy
            - keepalived

        - name: install
          ansible.builtin.apt:
            name: [ haproxy, keepalived, psmisc ]
            state: present
            update_cache: yes

        - name: write configs haproxy
          ansible.builtin.copy:
            force: yes
            dest: "/etc/haproxy/haproxy.cfg"
            content: '{{ lookup("template", "files/haproxy/haproxy.cfg.j2") }}'
            mode: 0644
            owner: haproxy
            group: haproxy

        - name: write configs keepalived
          ansible.builtin.copy:
            force: true
            dest: "/etc/keepalived/keepalived.conf"
            content: '{{ lookup("template", "files/keepalived/keepalived.conf.j2") }}'
            mode: 0644
            owner: haproxy
            group: haproxy

        - name: write haproxy / keepalived systemd services
          ansible.builtin.copy:
            force: true
            dest: "/etc/systemd/system/{{item}}.service"
            content: '{{ lookup("template", "files/{{item}}/{{item}}.service.j2") }}'
            mode: 0644
            owner: root
            group: root
          with_items:
          - keepalived
          - haproxy

        - name: iptables allow vrrp
          ansible.builtin.iptables:
            chain: INPUT
            protocol: vrrp
            jump: ACCEPT
            comment: INPUT-VRRP

        - name: reset failed
          ansible.builtin.shell: systemctl reset-failed "{{item}}"
          with_items:
            - keepalived.service
            - haproxy.service

        - name: enable and start
          ansible.builtin.systemd:
            name: "{{item}}"
            state: restarted
            enabled: true
            daemon_reload: true
          with_items:
            - keepalived.service
            - haproxy.service