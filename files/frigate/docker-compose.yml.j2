version: '3.8'

services:
  frigate:
    image: {{ image }}:{{ version }}
    container_name: {{ service }}
    hostname: {{ service }}
    restart: unless-stopped
    
    # GPU support for hardware acceleration
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - PUID={{ uid }}
      - PGID={{ gid }}
      - TZ=America/Los_Angeles
    
    # Privileged mode for hardware access
    privileged: true
    
    ports:
      - "{{ port_ext }}:5000"      # Web UI
      - "{{ rtsp_port }}:8554"     # RTSP feeds
      - "{{ webrtc_port }}:8555/tcp"   # WebRTC over TCP
      - "{{ webrtc_port }}:8555/udp"   # WebRTC over UDP
    
    volumes:
      - {{ home }}/config:/config
      - {{ home }}/media:/media/frigate
      - /etc/localtime:/etc/localtime:ro
      # Shared memory for video processing (half of system RAM recommended)
      - type: tmpfs
        target: /tmp/cache
        tmpfs:
          size: 4000000000  # 4GB
    
    # Shared memory for object detection
    shm_size: 256mb
    
    # Health check
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/api/stats || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Devices for hardware acceleration
    devices:
      - /dev/dri:/dev/dri  # Intel/AMD GPU
      # Uncomment if using Coral TPU
      # - /dev/bus/usb:/dev/bus/usb
      # - /dev/apex_0:/dev/apex_0
    
    # Network configuration
    networks:
      - frigate_network

networks:
  frigate_network:
    name: frigate_network
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-frigate
