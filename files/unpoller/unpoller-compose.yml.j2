version: '3.8'

services:
  unpoller:
    image: {{ unpoller_image }}:{{ unpoller_version }}
    container_name: {{ unpoller_service }}
    restart: unless-stopped
    
    # Networking
    ports:
      - "{{ unpoller_port }}:9130"
    
    # Configuration
    volumes:
      - {{ unpoller_home }}/config:/config:ro
    
    # Environment variables
    environment:
      - UP_UNIFI_DEFAULT_URL={{ unifi_controller_url }}
      - UP_UNIFI_DEFAULT_USER={{ unifi_username }}
      - UP_UNIFI_DEFAULT_PASS={{ unifi_password }}
      - UP_UNIFI_DEFAULT_VERIFY_SSL=false
      - UP_UNIFI_DEFAULT_TIMEOUT=30s
      - UP_PROMETHEUS_HTTP_LISTEN=0.0.0.0:9130
      - UP_PROMETHEUS_NAMESPACE=unifi
      - UP_INFLUXDB_DISABLE=true
      - UP_UNIFI_DEFAULT_SAVE_SITES=true
      - UP_UNIFI_DEFAULT_SAVE_DPI=true
      - UP_UNIFI_DEFAULT_SAVE_IDS=false
      - UP_UNIFI_DEFAULT_SAVE_EVENTS=false
      - UP_UNIFI_DEFAULT_SAVE_ALARMS=false
      - UP_UNIFI_DEFAULT_SAVE_ANOMALIES=false
      - UP_DEBUG=true
    
    # Health Check (check metrics endpoint)
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9130/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Security
    security_opt:
      - no-new-privileges:true
    
    # Resource Limits
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Use default bridge network mode (same as existing containers)
    network_mode: bridge

# No custom networks needed - using default bridge
