version: '3.8'

services:
  nextcloud:
    image: {{ image }}:{{ version }}
    container_name: {{ service }}
    hostname: {{ service }}
    restart: unless-stopped
    
    environment:
      # LinuxServer.io User/Group Configuration
      - PUID={{ uid }}
      - PGID={{ gid }}
      - TZ=America/Los_Angeles
      
      # Database Configuration
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD={{ cloud_services.nextcloud.database_password }}
      - MYSQL_HOST=nextcloud-db
      
      # Redis Configuration
      - REDIS_HOST=nextcloud-redis
      - REDIS_HOST_PORT=6379
      - REDIS_PASSWORD={{ cloud_services.nextcloud.redis_password }}
      
      # Admin User Configuration
      - NEXTCLOUD_ADMIN_USER={{ cloud_services.nextcloud.admin_user }}
      - NEXTCLOUD_ADMIN_PASSWORD={{ cloud_services.nextcloud.admin_password }}
      
      # URL Configuration - HTTP backend
      - NEXTCLOUD_TRUSTED_DOMAINS=nextcloud.home nextcloud.terrac.com {{ ansible_default_ipv4.address }}
      - OVERWRITEPROTOCOL=http
      - OVERWRITECLIURL=http://nextcloud.home/
      
      # PHP Configuration
      - PHP_MEMORY_LIMIT=2G
      - PHP_UPLOAD_LIMIT=10G
      - PHP_MAX_FILE_UPLOADS=100
    
    ports:
      - "{{ port }}:80"
    
    volumes:
      - {{ home }}/config:/config
      - {{ data }}/nextcloud-files:/data
      - {{ home }}/apps:/config/www/nextcloud/custom_apps
    
    # Health check
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/status.php || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Service dependencies
    depends_on:
      - nextcloud-db
      - nextcloud-redis
    
    # Network configuration
    networks:
      - nextcloud_network

  nextcloud-db:
    image: mariadb:10.11
    container_name: nextcloud-db
    hostname: nextcloud-db
    restart: unless-stopped
    
    command: --transaction-isolation=READ-COMMITTED --log-bin=binlog --binlog-format=ROW
    
    environment:
      - MYSQL_ROOT_PASSWORD={{ cloud_services.nextcloud.root_password }}
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD={{ cloud_services.nextcloud.database_password }}
      - MARIADB_AUTO_UPGRADE=1
      - MARIADB_DISABLE_UPGRADE_BACKUP=1
    
    volumes:
      - {{ home }}/database:/var/lib/mysql
    
    # Health check
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    
    # User mapping
    user: "{{ uid }}:{{ gid }}"
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Network configuration
    networks:
      - nextcloud_network

  nextcloud-redis:
    image: redis:7-alpine
    container_name: nextcloud-redis
    hostname: nextcloud-redis
    restart: unless-stopped
    
    command: redis-server --requirepass {{ cloud_services.nextcloud.redis_password }}
    
    volumes:
      - {{ home }}/redis:/data
    
    # Health check
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    
    # User mapping
    user: "{{ uid }}:{{ gid }}"
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Network configuration
    networks:
      - nextcloud_network

networks:
  nextcloud_network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-nextcloud
