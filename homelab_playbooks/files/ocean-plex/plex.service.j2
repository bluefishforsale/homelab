[Unit]
Description={{ service }}
After=docker.service zfs-mount.service zfs-import.target
Requires=docker.service zfs-mount.service zfs-import.target
RequiresMountsFor=/data01


[Service]
Type=simple
StandardOutput=journal
StandardError=journal
RuntimeMaxSec=7d
TimeoutStartSec=600
TimeoutStopSec=600
Restart=always
User={{ user }}
Group={{ user }}
ExecStartPre=-docker rm -f {{ service }}
ExecStartPre=-docker images --filter reference={{ image }}:{{ version }} -q | xargs docker rmi -f
ExecStartPre=-/usr/bin/docker pull {{ image }}:{{ version }}
ExecStart=docker run --rm \
    --name={{ service }} \
    --hostname={{ service }} \
    --runtime nvidia \
    {% for dev in devices -%}
    --device {{ dev }}:{{ dev }} \
    {% endfor -%}
    --gpus=all,capabilities=video \
    -e TZ="America/Los_Angeles" \
    -e VERSION={{ version }} \
    -e PLEX_CLAIM="{{ plex_claim }}" \
    -e ADVERTISE_IP="https://{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}32400/" \
    -e PLEX_UID={{ uid }} -e PLEX_GID={{ uid }} \
    -e NVIDIA_VISIBLE_DEVICES=all \
    -e NVIDIA_DRIVER_CAPABILITIES=compute,video,utility \
    {% for port in plex_ports_tcp -%}
    -p {{ port }}:{{ port }}/tcp \
    {% endfor -%}
    {% for port in plex_ports_udp -%}
    -p {{ port }}:{{ port }}/udp \
    {% endfor -%}
    -v /etc/letsencrypt/archive/home.terrac.com:/certs \
    -v {{ plex_home }}/config:/config \
    -v {{ plex_home }}/Profiles/Chromecast.xml:/usr/lib/plexmediaserver/Resources/Profiles/Chromecast.xml:ro \
    -v {{ complete }}/tv:/tv \
    -v {{ complete }}/music:/music \
    -v {{ complete }}/movies:/movies \
    -v {{ ramdisk }}:/transcode \
    -v {{ data }}:/data01 \
  {{ image }}:{{ version }}
ExecStop=docker rm -f {{ service }}

[Install]
WantedBy=multi-user.target
