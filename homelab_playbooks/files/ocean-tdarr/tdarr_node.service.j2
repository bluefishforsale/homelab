[Unit]
Description={{ service_node }}
After=docker.service zfs-mount.service zfs-import.target
Requires=docker.service zfs-mount.service zfs-import.target
RequiresMountsFor=/data01

[Service]
Type=simple
StandardOutput=journal
StandardError=journal
RuntimeMaxSec=7d
Restart=always
RestartSec=30s
TimeoutStartSec=601s
TimeoutStopSec=600s
ExecStartPre=-docker rm -f {{ service_node }}
ExecStartPre=-docker images --filter reference={{ node_image }}:{{ node_version }} -q | xargs docker rmi -f
ExecStartPre=-/usr/bin/docker pull {{ node_image }}:{{ node_version }}
ExecStart=docker run --rm\
    --name={{ service_node }} \
    --hostname={{ service_node }} \
    --runtime nvidia \
    --gpus='all,"capabilities=compute,utility,video"' \
    -e NVIDIA_VISIBLE_DEVICES=all \
    -e NVIDIA_DRIVER_CAPABILITIES=compute,video,utility \
    -e THREADS_WORKER_INIT_TIMEOUT=200000 \
    -e TZ="America/Los_Angeles" \
    -e PGID=1001 -e PUID=1001 \
    -e "serverIP={{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}" \
    -e "serverPort={{tdarr_port_api}}" \
    -e "nodePort={{node_port}}" \
    -e "nodeID={{ inventory_hostname }}.home" \
    -e "nodeIP={{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}" \
    -p {{ node_port }}:8267 \
    -v {{path_home}}/plugins/{{repo}}:/app/server/Tdarr/Plugins/Local \
    -v {{ path_complete }}:/media \
    -v {{ path_home }}/server:/app/server \
    -v {{ path_home }}/conf:/app/configs \
    -v {{ path_home }}/logs:/app/logs \
    -v {{ transcode }}:/temp \
  {{ node_image }}:{{ node_version }}
ExecStop=docker rm -f  {{ service }}

[Install]
WantedBy=multi-user.target
