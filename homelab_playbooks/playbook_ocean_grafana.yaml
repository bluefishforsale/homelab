---
- name: Configure systemd service for grafana
  hosts: ocean
  become: true
  gather_facts: true

  vars:
    image: grafana
    version: 1.27.3-alpine
    service: grafana
    path_data01: /data01/services
    path_home: "{{ path_data01 }}/{{ service }}"

  tasks:

  - name: Ensure basedir exists
    ansible.builtin.file:
      path: "{{ path_home }}"
      state: directory
      owner: root
      group: root
      mode: '0755'

  - name: Ensure directory exists with correct ownership and permissions
    ansible.builtin.file:
      path: "{{ path_home }}/{{ item }}"
      state: directory
      owner: root
      group: root
      mode: '0755'
    with_items:
    - logs
    - conf

  - name: Create config files
    ansible.builtin.template:
      src: "files/ocean-grafana/{{ item }}"
      dest: "{{ path_home }}/{{ item }}"
      mode: '0644'
    with_items:
    - grafana.ini
    notify:
    - Reload systemd daemon
    - Restart service

  - name: Create systemd service
    ansible.builtin.template:
      src: "files/ocean-grafana/{{ item }}.j2"
      dest: "/etc/systemd/system/{{ item }}"
      mode: '0644'
    with_items:
    - grafana.service
    notify:
    - Reload systemd daemon
    - Restart service

  handlers:
  - name: Reload systemd daemon
    ansible.builtin.systemd:
      daemon_reload: yes

  - name: Restart service
    ansible.builtin.systemd:
      name: grafana.service
      state: restarted
