---
- name: Configure systemd service for ollama
  hosts: ocean
  become: true
  gather_facts: true

  vars:
    image: ollama/ollama
    version: latest
    service: ollama
    port: 11434
    path_data01: /data01/services
    path_home: "{{ path_data01 }}/{{ service }}"

  tasks:

  - name: Ensure basedir exists
    ansible.builtin.file:
      path: "{{ path_home }}"
      state: directory
      owner: root
      group: root
      mode: '0755'

  - name: Ensure directory exists with correct ownership and permissions
    ansible.builtin.file:
      path: "{{ path_home }}/{{ item }}"
      state: directory
      owner: root
      group: root
      mode: '0755'
    with_items:
    - logs
    - conf

  - name: Create systemd service
    ansible.builtin.template:
      src: "files/ocean-ollama/{{ item }}.j2"
      dest: "/etc/systemd/system/{{ item }}"
      mode: '0644'
    with_items:
    - ollama.service
    notify:
    - Reload systemd daemon
    - Restart service

  - name: Wait for Ollama service to be active
    ansible.builtin.systemd:
      name: ollama
      state: started
    register: service_status
    until: service_status.status.ActiveState == "active"
    retries: 30
    delay: 10

  - name: Run llama3 model
    ansible.builtin.command: docker exec -it ollama ollama run llama3
    when: service_status.status.ActiveState == "active"

  handlers:
  - name: Reload systemd daemon
    ansible.builtin.systemd:
      daemon_reload: yes

  - name: Restart service
    ansible.builtin.systemd:
      name: ollama.service
      state: restarted
