---
- name: IO Scheduler, CPU scheduler, APC UPS
  become: true
  hosts: baremetal
  strategy: free
  tasks:
    - name: Update apt cache if not done in the last 24 hours
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 86400  # 24 hours

    - name: Check if ZFS is loaded
      ansible.builtin.shell: lsmod | grep -q '^zfs' && zpool list 2>/dev/null
      register: zfs_check
      changed_when: false
      failed_when: false

    - name: Set ZFS presence fact
      ansible.builtin.set_fact:
        has_zfs: "{{ zfs_check.rc == 0 }}"

    - name: Show ZFS detection result
      ansible.builtin.debug:
        msg: "ZFS detected: {{ has_zfs }}"

    - name: Write IO scheduler script (ZFS hosts)
      ansible.builtin.copy:
        force: true
        dest: "/etc/systemd/system/io-scheduler.sh"
        mode: 0755
        content: |
          # For ZFS, use 'none' scheduler as ZFS has its own IO scheduling
          for SCH in /sys/block/*/queue/scheduler ; do
              echo "none" > "${SCH}" 2>/dev/null || echo "noop" > "${SCH}" 2>/dev/null
          done
          # Larger queue depth for better throughput
          for DEPTH in /sys/block/*/queue/nr_requests ; do
              echo "2048" > "${DEPTH}" 2>/dev/null
          done
          # Larger readahead for sequential media streaming (8MB)
          for RAHEAD in /sys/block/*/queue/read_ahead_kb ; do
              echo "8192" > "${RAHEAD}" 2>/dev/null
          done
      when: has_zfs | bool

    - name: Write IO scheduler script (non-ZFS hosts)
      ansible.builtin.copy:
        force: true
        dest: "/etc/systemd/system/io-scheduler.sh"
        mode: 0755
        content: |
          # Use deadline scheduler for traditional filesystems
          for SCH in /sys/block/*/queue/scheduler ; do
              echo "mq-deadline" > "${SCH}" 2>/dev/null || echo "deadline" > "${SCH}" 2>/dev/null
          done
          # Standard queue depth
          for DEPTH in /sys/block/*/queue/nr_requests ; do
              echo "1024" > "${DEPTH}" 2>/dev/null
          done
          # Moderate readahead (4MB)
          for RAHEAD in /sys/block/*/queue/read_ahead_kb ; do
              echo "4096" > "${RAHEAD}" 2>/dev/null
          done
      when: not (has_zfs | bool)

    - name: Write IO scheduler service
      ansible.builtin.copy:
        force: true
        dest: "/etc/systemd/system/io-scheduler.service"
        content: |
          [Unit]
          Description=Setup IO Scheduler
          #After=network.target

          [Service]
          Type=oneshot
          ExecStart=sh -c /etc/systemd/system/io-scheduler.sh
          RemainAfterExit=true
          StandardOutput=journal

          [Install]
          WantedBy=multi-user.target

    - name: Write blockdev readahead service (ZFS hosts)
      ansible.builtin.copy:
        force: true
        dest: "/etc/systemd/system/blockdev-setra.service"
        content: |
          [Unit]
          Description=Set readahead for the hard drive device
          After=local-fs.target

          [Service]
          Type=oneshot
          # 16MB readahead for large sequential media file streaming
          # Handle /dev/sd*, /dev/nvme*, and /dev/vd* devices
          ExecStart=/bin/bash -c 'for dev in /dev/sd[a-z] /dev/sd[a-z][a-z] /dev/nvme[0-9]n[0-9] /dev/vd[a-z]; do [ -b "$dev" ] && /sbin/blockdev --setra 16384 "$dev" 2>/dev/null || true; done'

          [Install]
          WantedBy=multi-user.target
      when: has_zfs | bool

    - name: Write blockdev readahead service (non-ZFS hosts)
      ansible.builtin.copy:
        force: true
        dest: "/etc/systemd/system/blockdev-setra.service"
        content: |
          [Unit]
          Description=Set readahead for the hard drive device
          After=local-fs.target

          [Service]
          Type=oneshot
          # 8MB readahead for standard filesystems
          # Handle /dev/sd*, /dev/nvme*, and /dev/vd* devices
          ExecStart=/bin/bash -c 'for dev in /dev/sd[a-z] /dev/sd[a-z][a-z] /dev/nvme[0-9]n[0-9] /dev/vd[a-z]; do [ -b "$dev" ] && /sbin/blockdev --setra 8192 "$dev" 2>/dev/null || true; done'

          [Install]
          WantedBy=multi-user.target
      when: not (has_zfs | bool)

    - name: Write cpufrequtils GOVERNOR
      ansible.builtin.copy:
        force: true
        dest: /etc/default/cpufrequtils
        mode: "0644"
        content: GOVERNOR="powersave"

    - name: Write CPU performance script
      ansible.builtin.copy:
        force: true
        dest: "/etc/systemd/system/cpu-performance.sh"
        mode: "0755"
        content: |
          for CPU in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor ; do
              echo "performance" > "${CPU}" 2>/dev/null
          done

    - name: Write CPU performance service
      ansible.builtin.copy:
        force: true
        dest: "/etc/systemd/system/cpu-performance.service"
        content: |
          [Unit]
          Description=Setup CPU Performance
          #After=network.target

          [Service]
          Type=oneshot
          ExecStart=sh -c /etc/systemd/system/cpu-performance.sh
          RemainAfterExit=true
          StandardOutput=journal

          [Install]
          WantedBy=multi-user.target

    - name: Write ZFS tuning sysctl configuration (ZFS hosts)
      ansible.builtin.copy:
        force: true
        dest: "/etc/sysctl.d/99-zfs-tuning.conf"
        mode: "0644"
        content: |
          # ZFS-specific tuning
          # ZFS ARC tuning for media streaming workload
          # Set ARC max to 50% of RAM (adjust based on your total RAM)
          # This caches metadata and frequently accessed files
          # Example: 32GB RAM = 16GB ARC max (in bytes)
          # vm.arc_max = 17179869184
          
          # Minimum ARC size (25% of max, adjust to your needs)
          # vm.arc_min = 4294967296
          
          # Network tuning for streaming
          # Increase TCP buffer sizes for better streaming performance
          net.core.rmem_max = 134217728
          net.core.wmem_max = 134217728
          net.core.rmem_default = 16777216
          net.core.wmem_default = 16777216
          net.ipv4.tcp_rmem = 4096 87380 67108864
          net.ipv4.tcp_wmem = 4096 65536 67108864
          
          # Reduce swappiness - prefer using RAM for caching
          vm.swappiness = 10
          
          # VFS cache pressure - lower value preserves directory/inode cache
          # Good for media libraries with many files
          vm.vfs_cache_pressure = 50
      when: has_zfs | bool

    - name: Write general tuning sysctl configuration (non-ZFS hosts)
      ansible.builtin.copy:
        force: true
        dest: "/etc/sysctl.d/99-system-tuning.conf"
        mode: "0644"
        content: |
          # General system tuning for media streaming
          
          # Network tuning for streaming
          # Increase TCP buffer sizes for better streaming performance
          net.core.rmem_max = 134217728
          net.core.wmem_max = 134217728
          net.core.rmem_default = 16777216
          net.core.wmem_default = 16777216
          net.ipv4.tcp_rmem = 4096 87380 67108864
          net.ipv4.tcp_wmem = 4096 65536 67108864
          
          # Reduce swappiness - prefer using RAM for caching
          vm.swappiness = 10
          
          # VFS cache pressure - lower value preserves directory/inode cache
          # Good for media libraries with many files
          vm.vfs_cache_pressure = 50
          
          # Dirty page writeback tuning
          vm.dirty_ratio = 40
          vm.dirty_background_ratio = 10
      when: not (has_zfs | bool)

    - name: Write ZFS module parameters
      ansible.builtin.copy:
        force: true
        dest: "/etc/modprobe.d/zfs.conf"
        mode: "0644"
        content: |
          # ZFS ARC size limits (in bytes)
          # Uncomment and adjust based on your RAM
          # For 32GB RAM, 16GB max ARC is reasonable
          # options zfs zfs_arc_max=17179869184
          # options zfs zfs_arc_min=4294967296
          
          # Enable ZFS prefetcher for sequential reads (media streaming)
          options zfs zfs_prefetch_disable=0
          
          # Prefetch metadata more aggressively (helps with directory listings)
          options zfs zfs_arc_meta_prune=10000
          
          # L2ARC tuning (if you add an SSD cache later)
          # options zfs l2arc_write_max=50331648
          # options zfs l2arc_write_boost=67108864
      when: has_zfs | bool

    - name: Apply ZFS sysctl settings
      ansible.builtin.command:
        cmd: sysctl -p /etc/sysctl.d/99-zfs-tuning.conf
      changed_when: false
      failed_when: false
      when: has_zfs | bool

    - name: Apply general sysctl settings (non-ZFS hosts)
      ansible.builtin.command:
        cmd: sysctl -p /etc/sysctl.d/99-system-tuning.conf
      changed_when: false
      failed_when: false
      when: not (has_zfs | bool)

    - name: Temporarily disable services
      ansible.builtin.systemd:
        name: "{{item}}"
        state: stopped
        enabled: false
        daemon_reload: true
      with_items:
        - cpu-performance

    - name: Enable and restart performance services
      ansible.builtin.systemd:
        name: "{{item}}"
        state: restarted
        enabled: true
        daemon_reload: true
      with_items:
        - blockdev-setra
        - io-scheduler
        - rsyslog
        - logrotate
        - cpufrequtils
        - fail2ban

    - name: UPS battery backups
      when: apcupsd is defined
      block:

      - name: Print debug
        ansible.builtin.debug:
          msg: "APC UPSd software and config"

      - name: Install APC UPS tools
        ansible.builtin.apt:
          pkg: [apcupsd]

      - name: APCUPSd config
        ansible.builtin.copy:
          force: true
          dest: "/etc/apcupsd/apcupsd.conf"
          content: |
            UPSNAME smartups1500
            UPSCABLE usb
            UPSTYPE usb
            MINUTES 7
            DEVICE
            POLLTIME 60

      - name: UPSd /etc/default config
        ansible.builtin.copy:
          force: true
          dest: "/etc/default/apcupsd"
          content: |
            ISCONFIGURED=true

      - name: Min time left script
        ansible.builtin.copy:
          force: true
          mode: "0755"
          dest: "/etc/apcupsd/runlimit"
          content: |
            #!/bin/bash
            # http://www.apcupsd.org/manual/manual.html#configure-options
            for host in ocean.home $(printf "node%03d " $(seq 1 6) | xargs -n1 | grep -vi $(hostname)) ; do ssh -l ubuntu ${host} 'sudo hostname' & done
            wait
            shutdown -h now

      - name: Enable and restart APC UPS services
        ansible.builtin.systemd:
          name: apcupsd
          state: restarted
          enabled: true
          daemon_reload: true


