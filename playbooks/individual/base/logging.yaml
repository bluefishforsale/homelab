---
- name: Configure System Logging
  become: true
  hosts: all
  strategy: free
  vars:
    SYSLOG: "192.168.1.65"
    LOKI_URL: "http://192.168.1.143:3100"
  tasks:
  ########### Syslog
  - name: Install rsyslog
    apt:
      name: rsyslog
      state: latest
      update_cache: no

  - name: Create /etc/rsyslog.d/ directory
    ansible.builtin.file:
      path: /etc/rsyslog.d/
      state: directory

  - name: Rsyslog drop IPVS no route messages
    ansible.builtin.copy:
      force: true
      dest: "/etc/rsyslog.d/0-drop-ipvs-spam.conf"
      content: |
        :msg, regex, ".*IPVS.*no destination available" ~
    notify:
    - Restart rsyslogd

  - name: Rsyslog remote server configuration
    ansible.builtin.copy:
      force: true
      dest: "/etc/rsyslog.d/99-remote-syslog.conf"
      content: |
        # This file is managed by ansible

        module(load="omprog")
        module(load="mmutf8fix")
        action(type="mmutf8fix" replacementChar="?")
        action(type="omfwd" protocol="tcp" target="{{SYSLOG}}" port="1514" Template="RSYSLOG_SyslogProtocol23Format" TCP_Framing="octet-counted")
    notify:
    - Restart rsyslogd

  ########### systemd-journald
  - name: Write journald config
    ansible.builtin.copy:
      force: true
      dest: "/etc/systemd/journald.conf"
      content: |
        # This file is managed by ansible

        [Journal]
        Storage=volatile
        StandardOutput=journal
        StandardError=journal
        Compress=true
        LineMax=10K
        SystemMaxUse=500M
        SystemMaxFileSize=100M
        SystemMaxFiles=5
        MaxRetentionSec=2week
        ForwardToSyslog=false
    notify:
    - Restart systemd-journald

  ########### System log rotation
  - name: Configure logrotate for system logs
    ansible.builtin.copy:
      dest: /etc/logrotate.d/rsyslog
      content: |
        # Custom logrotate config for homelab
        /var/log/syslog {
            daily
            rotate 7
            missingok
            notifempty
            compress
            delaycompress
            sharedscripts
            postrotate
                /usr/lib/rsyslog/rsyslog-rotate
            endscript
        }
        
        /var/log/kern.log {
            daily
            rotate 7
            missingok
            notifempty
            compress
            delaycompress
        }
        
        /var/log/auth.log {
            daily
            rotate 14
            missingok
            notifempty
            compress
            delaycompress
        }
        
        /var/log/daemon.log {
            daily
            rotate 7
            missingok
            notifempty
            compress
            delaycompress
        }
      mode: '0644'

  - name: Configure APT to clean cache automatically
    ansible.builtin.copy:
      dest: /etc/apt/apt.conf.d/99-clean-cache
      content: |
        APT::Periodic::Download-Upgradeable-Packages "0";
        APT::Periodic::AutocleanInterval "7";
        APT::Archives::MaxAge "30";
        APT::Archives::MinAge "2";
        APT::Archives::MaxSize "500";
      mode: '0644'

  ########### Promtail
  - name: Create APT keyrings directory
    ansible.builtin.file:
      path: /etc/apt/keyrings
      state: directory
      mode: '0755'

  - name: Add Grafana GPG key
    ansible.builtin.apt_key:
      url: https://apt.grafana.com/gpg.key
      state: present
      keyring: /etc/apt/keyrings/grafana.gpg

  - name: Add Grafana APT repository
    ansible.builtin.apt_repository:
      repo: "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main"
      state: present
      filename: grafana

  - name: Install Promtail
    ansible.builtin.apt:
      name: promtail
      state: present
      update_cache: yes

  - name: Create Promtail config directory
    ansible.builtin.file:
      path: /etc/promtail
      state: directory
      mode: '0755'

  - name: Deploy Promtail configuration
    ansible.builtin.copy:
      dest: /etc/promtail/config.yml
      content: |
        # Promtail configuration - managed by Ansible
        server:
          http_listen_port: 9080
          grpc_listen_port: 0

        positions:
          filename: /var/lib/promtail/positions.yaml

        clients:
          - url: {{ LOKI_URL }}/loki/api/v1/push

        scrape_configs:
          # Scrape systemd journal (includes Docker logs via journald)
          - job_name: systemd-journal
            journal:
              path: /run/log/journal
              max_age: 12h
              labels:
                job: systemd-journal
                host: {{ inventory_hostname }}
            relabel_configs:
              - source_labels: ['__journal__systemd_unit']
                target_label: 'unit'
              - source_labels: ['__journal__hostname']
                target_label: 'hostname'
              - source_labels: ['__journal_priority_keyword']
                target_label: 'level'
              - source_labels: ['__journal__transport']
                target_label: 'transport'
              - source_labels: ['__journal_container_name']
                target_label: 'container'
              - source_labels: ['__journal_container_id']
                target_label: 'container_id'
      mode: '0644'
    notify:
      - Restart promtail
    when: inventory_hostname != 'ocean'

  - name: Deploy Promtail configuration with syslog listener (ocean only)
    ansible.builtin.copy:
      dest: /etc/promtail/config.yml
      content: |
        # Promtail configuration - managed by Ansible
        server:
          http_listen_port: 9080
          grpc_listen_port: 0

        positions:
          filename: /var/lib/promtail/positions.yaml

        clients:
          - url: {{ LOKI_URL }}/loki/api/v1/push

        scrape_configs:
          # Scrape systemd journal (includes Docker logs via journald)
          - job_name: systemd-journal
            journal:
              path: /run/log/journal
              max_age: 12h
              labels:
                job: systemd-journal
                host: {{ inventory_hostname }}
            relabel_configs:
              - source_labels: ['__journal__systemd_unit']
                target_label: 'unit'
              - source_labels: ['__journal__hostname']
                target_label: 'hostname'
              - source_labels: ['__journal_priority_keyword']
                target_label: 'level'
              - source_labels: ['__journal__transport']
                target_label: 'transport'
              - source_labels: ['__journal_container_name']
                target_label: 'container'
              - source_labels: ['__journal_container_id']
                target_label: 'container_id'

          # Syslog listener for remote devices
          - job_name: syslog
            syslog:
              listen_address: 0.0.0.0:1514
              idle_timeout: 60s
              label_structured_data: yes
              labels:
                job: syslog
            relabel_configs:
              - source_labels: ['__syslog_message_hostname']
                target_label: 'hostname'
              - source_labels: ['__syslog_message_severity']
                target_label: 'level'
              - source_labels: ['__syslog_message_app_name']
                target_label: 'application'
              - source_labels: ['__syslog_message_facility']
                target_label: 'facility'
      mode: '0644'
    notify:
      - Restart promtail
    when: inventory_hostname == 'ocean'

  - name: Create Promtail positions directory
    ansible.builtin.file:
      path: /var/lib/promtail
      state: directory
      mode: '0755'

  - name: Enable and start Promtail service
    ansible.builtin.systemd:
      name: promtail
      enabled: yes
      state: started
      daemon_reload: yes

  handlers:
  - name: Restart rsyslogd
    ansible.builtin.systemd:
      daemon_reload: yes
      state: restarted
      enabled: true
      name: rsyslog.service

  - name: Restart systemd-journald
    ansible.builtin.systemd:
      daemon_reload: yes
      state: restarted
      enabled: true
      name: systemd-journald.service

  - name: Restart promtail
    ansible.builtin.systemd:
      daemon_reload: yes
      state: restarted
      enabled: true
      name: promtail.service
