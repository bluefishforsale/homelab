---
- name: Create Pi-hole VM on Proxmox
  hosts: pihole
  gather_facts: false
  vars:
    vm_id: 3000
    template_id: 9999
    vm_cores: 1
    vm_memory: 1024
    vm_disk_size: "+8G"
  tasks:
    - name: Check if running on a VM with bare_metal_host defined
      set_fact:
        is_proxmox_vm: "{{ bare_metal_host is defined }}"
      tags: ['always']

    - name: VM creation tasks
      when: is_proxmox_vm | bool
      delegate_to: "{{ bare_metal_host }}"
      become: true
      block:
        - name: Check if VM already exists
          ansible.builtin.shell: "qm status {{ vm_id }} 2>/dev/null || echo 'not_found'"
          register: vm_status
          changed_when: false
          failed_when: false
          tags: ['always']

        - name: Destroy existing VM if force tag is set
          when:
            - "'force' in ansible_run_tags"
            - vm_status.stdout != 'not_found'
          tags: ['force']
          block:
            - name: Stop VM if running
              ansible.builtin.command: "qm stop {{ vm_id }}"
              failed_when: false
              
            - name: Unlock VM if locked
              ansible.builtin.command: "qm unlock {{ vm_id }}"
              failed_when: false
              
            - name: Destroy VM with purge to remove all volumes
              ansible.builtin.command: "qm destroy {{ vm_id }} --purge"
              
            - name: Wait for VM to be fully destroyed
              ansible.builtin.pause:
                seconds: 5

        - name: Create VM from template
          when: vm_status.stdout == 'not_found' or 'force' in ansible_run_tags
          tags: ['force', 'install']
          block:
            - name: Clean up orphaned LVM volumes if they exist
              ansible.builtin.shell: |
                set +e
                for vol in $(lvs --noheadings -o lv_name pve 2>/dev/null | awk '{print $1}' | grep "^vm-{{ vm_id }}"); do
                  echo "Removing orphaned volume: pve/$vol"
                  lvremove -f pve/$vol
                done
                exit 0
              register: cleanup_result
              changed_when: cleanup_result.stdout | length > 0
              
            - name: Display cleanup results
              ansible.builtin.debug:
                msg: "{{ cleanup_result.stdout_lines }}"
              when: cleanup_result.stdout | length > 0
              
            - name: Clone VM from template
              ansible.builtin.command: "qm clone {{ template_id }} {{ vm_id }}"
              
            - name: Set VM name
              ansible.builtin.command: "qm set {{ vm_id }} --name {{ inventory_hostname }}"
              
            - name: Configure network with multiqueue
              ansible.builtin.command: "qm set {{ vm_id }} --net0 virtio,bridge=vmbr0,queues=64"
              
            - name: Configure IP address
              ansible.builtin.command: "qm set {{ vm_id }} --ipconfig0 ip={{ ansible_ssh_host }}/24,gw={{ gateway }}"
              
            - name: Set nameserver
              ansible.builtin.command: "qm set {{ vm_id }} --nameserver={{ nameserver }}"
              
            - name: Enable onboot
              ansible.builtin.command: "qm set {{ vm_id }} --onboot 1"
              
            - name: Set CPU cores
              ansible.builtin.command: "qm set {{ vm_id }} --cores {{ vm_cores }}"
              
            - name: Set memory
              ansible.builtin.command: "qm set {{ vm_id }} --memory {{ vm_memory }}"
              
            - name: Resize disk
              ansible.builtin.command: "qm resize {{ vm_id }} scsi0 {{ vm_disk_size }}"
              
            - name: Start VM
              ansible.builtin.command: "qm start {{ vm_id }}"
              
            - name: Wait for VM to boot and SSH to become available
              ansible.builtin.wait_for:
                host: "{{ ansible_ssh_host }}"
                port: 22
                delay: 10
                timeout: 300
                state: started
              delegate_to: localhost
              become: false
              
            - name: Wait for SSH to be fully ready
              ansible.builtin.pause:
                seconds: 10

- name: Install Pi-hole on Debian 12
  hosts: pihole
  become: true
  tags: ['force', 'install']
  vars_files:
    - ../../../vault/secrets.yaml
  vars:
    pihole_admin_password: "admin"

  tasks:
    ############  fix dpkg if things went sideways #####################
    - name: Handle dpkg locks and repair
      include_tasks: ../../../tasks/dpkg_lock.yaml

    ############  apt install #####################
    - name: update cache once
      ansible.builtin.apt:
        update_cache: true

    - name: Install prerequisites
      ansible.builtin.apt:
        name: "{{ item }}"
        state: present
      loop:
        - curl
        - procps
        - lsb-release
        - git

    - name: Git clone Pi-hole
      ansible.builtin.git:
        repo: https://github.com/pi-hole/pi-hole.git
        dest: /opt/pi-hole
        accept_hostkey: true
        force: true
        depth: 1
    
    - name: Create /etc/pihole directory
      file:
        path: /etc/pihole
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Create /etc/pihole/setupVars.conf with specified variables
      template:
        src: ../../../../files/pihole/etc/setupVars.conf.j2
        dest: /etc/pihole/setupVars.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart pihole-FTL

    - name: Create /etc/dnsmasq.d directory
      file:
        path: /etc/dnsmasq.d
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Configure dnsmasq to forward .home domain to BIND9
      copy:
        src: ../../../../files/pihole/etc/dnsmasq.d/02-local-dns.conf
        dest: /etc/dnsmasq.d/02-local-dns.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart pihole-FTL

    - name: Check if Pi-hole is already installed
      ansible.builtin.stat:
        path: /usr/local/bin/pihole
      register: pihole_installed

    - name: Install Pi-hole
      ansible.builtin.command: /opt/pi-hole/automated\ install/basic-install.sh --unattended
      when: not pihole_installed.stat.exists

    - name: Update Pi-Hole
      ansible.builtin.command: pihole -u
      failed_when: false
      changed_when: false

    - name: Enable Pi-hole at startup
      ansible.builtin.systemd:
        name: pihole-FTL
        enabled: true

    - name: Start Pi-hole service
      ansible.builtin.systemd:
        name: pihole-FTL
        state: started

    - name: Set Pi-hole admin password from vault
      ansible.builtin.command: pihole setpassword "{{ pihole.password }}"
      no_log: true
      changed_when: true
      retries: 3
      delay: 2
      register: password_result
      until: password_result.rc == 0

    ############  DNS validation #####################
    - name: Wait for DNS service to be fully ready
      ansible.builtin.pause:
        seconds: 5

    - name: Test local DNS resolution (ocean.home)
      ansible.builtin.command: dig +short @127.0.0.1 ocean.home
      register: local_dns_result
      changed_when: false
      failed_when: local_dns_result.stdout != '192.168.1.143'

    - name: Test external DNS resolution (google.com)
      ansible.builtin.command: dig +short @127.0.0.1 google.com
      register: external_dns_result
      changed_when: false
      failed_when: external_dns_result.stdout == ''

    - name: Display DNS validation results
      ansible.builtin.debug:
        msg:
          - "✓ Local DNS working - ocean.home resolves to: {{ local_dns_result.stdout }}"
          - "✓ External DNS working - google.com resolves to: {{ external_dns_result.stdout_lines[0] }}"

  handlers:
    - name: Restart pihole-FTL
      ansible.builtin.service:
        name: pihole-FTL
        state: restarted

