# GitHub Self-Hosted Runners - Complete Setup Guide

This guide provides step-by-step instructions for deploying fully automated GitHub Actions self-hosted runners in your homelab.

## Architecture Overview

- **Runner VM**: Debian-based VM on Proxmox (`gh-runner-01` at `192.168.1.20`)
- **Runner Containers**: 4 ephemeral Docker containers using `myoung34/github-runner:latest`
- **Authentication**: GitHub Personal Access Token (PAT) stored in Ansible Vault
- **SSH Access**: Runners have SSH keys to access homelab hosts for Ansible playbooks

## Prerequisites

1. Proxmox host (`node005` at `192.168.1.105`)
2. Ansible Vault configured with secrets
3. GitHub account with repository access

## Step 1: Create GitHub Personal Access Token

The runner Docker image requires a PAT to automatically generate registration tokens.

### Create the PAT

1. Go to: https://github.com/settings/tokens
2. Click **"Generate new token"** → **"Generate new token (classic)"**
3. Token name: `homelab-github-runners`
4. Select scopes:
   - ✅ `repo` (Full control of private repositories)
   - ✅ `workflow` (Update GitHub Action workflows)
5. Click **"Generate token"**
6. **COPY THE TOKEN** - you won't see it again!

### Add PAT to Ansible Vault

```bash
# Navigate to homelab directory
cd ~/Projects/bluefishorsale/homelab

# Decrypt vault (temporary)
ansible-vault decrypt vault/secrets.yaml --output vault/secrets_plain.yaml

# Edit the plain file
nano vault/secrets_plain.yaml
```

Add this section to your vault file:

```yaml
development:
  github:
    vault_github_pat: "ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"  # Your PAT here
```

Re-encrypt the vault:

```bash
# Remove old encrypted file
rm vault/secrets.yaml

# Re-encrypt
ansible-vault encrypt vault/secrets_plain.yaml --output vault/secrets.yaml

# Clean up
rm vault/secrets_plain.yaml
```

## Step 2: Create Runner VM

Create the Proxmox VM that will host the runner containers:

```bash
ansible-playbook -i inventories/production/hosts.ini \
  playbooks/individual/infrastructure/create_runner_vm.yaml \
  --ask-vault-pass
```

**What this does:**
- Creates VM ID 5000 (`gh-runner-01`)
- Assigns IP: `192.168.1.20`
- 4 vCPUs, 8GB RAM, 32GB disk
- Cloned from template 9999
- Waits up to 5 minutes for SSH to be ready

## Step 3: Deploy GitHub Runners

Deploy the Docker-based runners on the VM:

```bash
ansible-playbook -i inventories/github_runners/hosts.ini \
  playbooks/individual/infrastructure/github_docker_runners.yaml \
  --ask-vault-pass
```

**What this does:**
- Installs Docker
- Creates github-runner user (uid/gid 1100)
- Generates ed25519 SSH key for runners
- Deploys 4 ephemeral runner containers
- Configures systemd service for management
- Mounts Docker socket for Docker-in-Docker support

## Step 4: Add SSH Public Key to GitHub

The deployment will output the runner's SSH public key. Add it to GitHub:

```
======================================================================
SSH PUBLIC KEY - ADD TO GITHUB
======================================================================

ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIN3toICbot7XCL3scNEUvJxgtObxv4wS5sbV7uIk5HzP github-runner@gh-runner-01

Add this key to: https://github.com/settings/keys
Title: github-runner@gh-runner-01
======================================================================
```

1. Copy the `ssh-ed25519 ...` key
2. Go to: https://github.com/settings/keys
3. Click **"New SSH key"**
4. Title: `github-runner@gh-runner-01`
5. Paste the key
6. Click **"Add SSH key"**

## Step 5: Verify Runners

Check that runners are registered and online:

1. Go to: https://github.com/bluefishforsale/homelab/settings/actions/runners
2. You should see 4 runners:
   - `gh-runner-01-runner-1`
   - `gh-runner-01-runner-2`
   - `gh-runner-01-runner-3`
   - `gh-runner-01-runner-4`
3. Status should be **"Idle"** (green)

### Manual Verification

SSH to the runner VM and check containers:

```bash
ssh debian@192.168.1.20

# Check containers are running
sudo docker ps

# Check runner logs
sudo docker logs github-runner-1

# Check systemd service
sudo systemctl status github-docker-runners
```

## How It Works

### Ephemeral Runner Lifecycle

1. Container starts with PAT from environment variable
2. Container calls GitHub API to generate registration token
3. Runner registers with GitHub
4. Runner picks up and executes one job
5. Runner exits after job completes
6. Docker restarts container (restart: always)
7. Process repeats from step 2

### Token Management

- **PAT**: Stored in Ansible Vault, never expires (unless you revoke it)
- **Registration Tokens**: Auto-generated by container, expire in 1 hour (handled automatically)
- **Token File**: `/opt/github-runners/.github_token` (read-only mount into containers)

### SSH Access

Runners can SSH to any homelab host using the shared SSH key:

```yaml
# In your workflow
- name: Run Ansible playbook
  run: |
    ansible-playbook -i inventories/production/hosts.ini \
      playbooks/example.yaml
```

## Management Commands

### View Runner Status

```bash
ssh debian@192.168.1.20 "sudo docker ps"
```

### View Runner Logs

```bash
ssh debian@192.168.1.20 "sudo docker logs github-runner-1 --tail 50"
```

### Restart All Runners

```bash
ssh debian@192.168.1.20 "sudo systemctl restart github-docker-runners"
```

### Update PAT

If you need to rotate the PAT:

1. Generate new PAT on GitHub (same scopes)
2. Update Ansible Vault with new PAT
3. Re-run the deployment playbook:

```bash
ansible-playbook -i inventories/github_runners/hosts.ini \
  playbooks/individual/infrastructure/github_docker_runners.yaml \
  --ask-vault-pass
```

## Troubleshooting

### Runners Not Showing in GitHub

**Check logs:**
```bash
ssh debian@192.168.1.20 "sudo docker logs github-runner-1"
```

**Common issues:**
- PAT expired or invalid scopes
- Network connectivity to GitHub API
- Token file permissions incorrect

### Runners Constantly Restarting

**Check for errors:**
```bash
ssh debian@192.168.1.20 "sudo docker logs github-runner-1 2>&1 | grep -i error"
```

**Common causes:**
- Invalid PAT (401 errors)
- Wrong repository URL
- Missing required environment variables

### SSH Key Not Working

**Verify key is mounted:**
```bash
ssh debian@192.168.1.20 "sudo docker exec github-runner-1 ls -la /root/.ssh/"
```

**Check permissions:**
```bash
ssh debian@192.168.1.20 "ls -la /home/github-runner/.ssh/"
```

## Workflow Example

Create `.github/workflows/test-runner.yml`:

```yaml
name: Test Self-Hosted Runner

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: self-hosted
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Test Runner
        run: |
          echo "Running on: $(hostname)"
          echo "OS: $(uname -a)"
          docker --version
      
      - name: Test Ansible
        run: |
          ansible --version
          ansible all -i inventories/production/hosts.ini -m ping
```

## Security Considerations

1. **PAT Security**
   - Stored in encrypted Ansible Vault
   - Never committed to version control
   - Only accessible to ansible user on control node

2. **SSH Key**
   - Generated on runner VM, never leaves the host
   - Mounted read-only into containers
   - Can be revoked by removing from GitHub

3. **Container Isolation**
   - Runners run as non-root user
   - Ephemeral: Fresh container for each job
   - No persistent state between jobs

4. **Network Access**
   - Runners can access homelab hosts via SSH
   - Outbound HTTPS to GitHub only
   - No inbound connections to runners

## Advanced Configuration

### Adjust Runner Count

Edit `inventories/github_runners/group_vars/github_runners.yml`:

```yaml
github_runner_count: 8  # Default is 4
```

### Add Custom Labels

```yaml
github_runner_labels:
  - self-hosted
  - homelab
  - ansible
  - ephemeral
  - docker
  - linux
  - x64
  - my-custom-label  # Add your label
```

### Resource Limits

Edit `roles/github_docker_runners/templates/docker-compose.yml.j2`:

```yaml
deploy:
  resources:
    limits:
      cpus: '2'      # Max CPU cores per runner
      memory: 2G     # Max RAM per runner
```

## Next Steps

- Set up workflow to auto-deploy homelab changes
- Configure workflow to run scheduled tasks
- Add more runners for parallel job execution
- Integrate with CI/CD pipelines

---

**Documentation Version:** 1.0  
**Last Updated:** 2025-11-22  
**Maintained By:** bluefishforsale
