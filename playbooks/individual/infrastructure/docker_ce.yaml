- name: Install Docker CE on Debian 12
  hosts: all
  become: yes
  vars_files:
    - ../../../vault/secrets.yaml
  vars:
    docker_keyring_path: /etc/apt/keyrings/docker.asc

  tasks:
  - name: Install prerequisite packages
    apt:
      name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - software-properties-common
      state: present
      update_cache: yes

  - name: Ensure /etc/docker directory exists
    file:
      path: /etc/docker
      state: directory
      mode: '0755'

  - name: Ensure /etc/apt/keyrings directory exists
    file:
      path: /etc/apt/keyrings
      state: directory
      mode: '0755'

  - name: Add Docker APT key directly (replacing deprecated apt_key)
    ansible.builtin.get_url:
      url: https://download.docker.com/linux/debian/gpg
      dest: "{{ docker_keyring_path }}"
      mode: '0644'

  - name: Add Docker repository
    apt_repository:
      repo: "deb [signed-by={{ docker_keyring_path }}] https://download.docker.com/linux/debian bookworm stable"
      state: present
      filename: docker

  - name: Update APT cache
    apt:
      update_cache: yes

  - name: Install Docker packages
    apt:
      name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-compose-plugin
      state: present

  - name: Ensure docker group exists
    ansible.builtin.group:
      name: docker
      state: present

  - name: Create media group with GID from vault
    ansible.builtin.group:
      name: media
      gid: "{{ system_users.media.gid }}"
      state: present

  - name: Create media user with UID from vault
    ansible.builtin.user:
      name: media
      uid: "{{ system_users.media.uid }}"
      group: media
      groups: docker
      shell: /bin/bash
      home: /home/media
      create_home: yes
      state: present

  - name: Add terrac user to docker group
    ansible.builtin.user:
      name: terrac
      groups: docker
      append: yes

  - name: Ensure Docker daemon.json is configured correctly
    ansible.builtin.template:
      src: ../../../files/docker/daemon.json.j2
      dest: /etc/docker/daemon.json
      owner: root
      group: root
      mode: '0644'

  - name: Install jq package
    ansible.builtin.apt:
      name: jq
      state: present
      update_cache: yes

  - name: Format Docker daemon.json using jq and write it back to /etc/docker/daemon.json
    ansible.builtin.command:
      cmd: jq . /etc/docker/daemon.json
    register: formatted_json
    changed_when: false

  - name: Overwrite /etc/docker/daemon.json with formatted version
    ansible.builtin.copy:
      content: "{{ formatted_json.stdout }}"
      dest: /etc/docker/daemon.json
      owner: root
      group: root
      mode: '0644'

  - name: Ensure docker service override directory exists
    ansible.builtin.file:
      path: /etc/systemd/system/docker.service.d
      state: directory
      owner: root
      group: root
      mode: '0755'

  - name: Ensure docker service has extended timeouts (systemd override)
    ansible.builtin.copy:
      dest: /etc/systemd/system/docker.service.d/override.conf
      content: |
        [Service]
        TimeoutStartSec=600
        TimeoutStopSec=600
      owner: root
      group: root
      mode: '0644'
    notify: restart docker

  - name: Create Docker cleanup script
    ansible.builtin.copy:
      dest: /usr/local/bin/docker-cleanup
      content: |
        #!/bin/bash
        # Docker cleanup script for homelab hosts
        set -e
        echo "$(date): Starting Docker cleanup..."
        docker container prune -f --filter "until=24h" || true
        docker image prune -f || true
        docker image prune -a -f --filter "until=168h" || true
        docker volume prune -f || true
        docker builder prune -a -f --filter "until=168h" || true
        docker network prune -f || true
        echo "$(date): Docker cleanup completed"
      mode: '0755'
      owner: root
      group: root

  - name: Create systemd timer for Docker cleanup
    ansible.builtin.copy:
      dest: /etc/systemd/system/docker-cleanup.timer
      content: |
        [Unit]
        Description=Docker cleanup timer
        
        [Timer]
        OnCalendar=weekly
        Persistent=true
        
        [Install]
        WantedBy=timers.target
      mode: '0644'

  - name: Create systemd service for Docker cleanup
    ansible.builtin.copy:
      dest: /etc/systemd/system/docker-cleanup.service
      content: |
        [Unit]
        Description=Docker cleanup service
        After=docker.service
        Requires=docker.service
        
        [Service]
        Type=oneshot
        ExecStart=/usr/local/bin/docker-cleanup
        StandardOutput=journal
        StandardError=journal
        
        [Install]
        WantedBy=multi-user.target
      mode: '0644'

  - name: Enable Docker cleanup timer
    ansible.builtin.systemd:
      name: docker-cleanup.timer
      enabled: yes
      state: started
      daemon_reload: yes

  - name: Truncate large existing Docker logs
    ansible.builtin.shell: |
      for log in $(find /var/lib/docker/containers -name '*-json.log' -size +10M 2>/dev/null); do
        echo "Truncating $log ($(du -h $log | cut -f1))"
        truncate -s 0 "$log"
      done
    changed_when: true
    failed_when: false

  # ============================================================================
  # NVIDIA GPU Support (Conditional)
  # ============================================================================

  - name: Install NVIDIA drivers and container toolkit
    when: nvidia_gpu | default(false) | bool
    block:
    - name: Get current kernel version
      ansible.builtin.command: uname -r
      register: kernel_version
      changed_when: false

    - name: Install NVIDIA driver prerequisites
      ansible.builtin.apt:
        name:
        - linux-headers-amd64
        - firmware-misc-nonfree
        - dkms
        - build-essential
        state: present
        update_cache: yes

    - name: Check if NVIDIA CUDA repository keyring exists
      ansible.builtin.stat:
        path: /usr/share/keyrings/cuda-archive-keyring.gpg
      register: cuda_keyring_exists

    - name: Download and install NVIDIA CUDA keyring (if not exists)
      ansible.builtin.get_url:
        url: https://developer.download.nvidia.com/compute/cuda/repos/debian12/x86_64/cuda-keyring_1.1-1_all.deb
        dest: /tmp/cuda-keyring_1.1-1_all.deb
        mode: '0644'
      when: not cuda_keyring_exists.stat.exists

    - name: Install NVIDIA CUDA keyring (if not exists)
      ansible.builtin.apt:
        deb: /tmp/cuda-keyring_1.1-1_all.deb
        state: present
      when: not cuda_keyring_exists.stat.exists
      register: cuda_keyring_installed

    - name: Update apt cache after CUDA keyring installation
      ansible.builtin.apt:
        update_cache: yes
      when: cuda_keyring_installed is changed

    - name: Upgrade NVIDIA driver packages to latest (CUDA 12.6+ support)
      ansible.builtin.apt:
        upgrade: full
        update_cache: yes
      register: nvidia_upgrade_result
      changed_when: "'nvidia' in nvidia_upgrade_result.stdout"

    - name: Blacklist Nouveau driver
      ansible.builtin.copy:
        dest: /etc/modprobe.d/blacklist-nouveau.conf
        content: |
          blacklist nouveau
          options nouveau modeset=0
        owner: root
        group: root
        mode: '0644'

    - name: Download and install NVIDIA Container Toolkit GPG key
      ansible.builtin.shell: |
        curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | \
          gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
      args:
        creates: /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg

    - name: Add NVIDIA Container Toolkit repository
      ansible.builtin.shell: |
        curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
          sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
          tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
      args:
        creates: /etc/apt/sources.list.d/nvidia-container-toolkit.list
      register: nvidia_repo_added

    - name: Update apt cache for NVIDIA Container Toolkit
      ansible.builtin.apt:
        update_cache: yes

    - name: Install NVIDIA Container Toolkit (latest)
      ansible.builtin.apt:
        name: 
          - nvidia-container-toolkit
          - nvidia-container-runtime
        state: latest
        update_cache: yes

    - name: Configure NVIDIA Container Runtime for Docker
      ansible.builtin.command: nvidia-ctk runtime configure --runtime=docker
      register: nvidia_runtime_config
      changed_when: nvidia_runtime_config.rc == 0
      notify: restart docker

    - name: Verify NVIDIA Container Toolkit installation
      ansible.builtin.command: nvidia-ctk --version
      register: nvidia_ctk_version
      changed_when: false
      failed_when: false

    - name: Display NVIDIA Container Toolkit version
      ansible.builtin.debug:
        msg: "NVIDIA Container Toolkit version: {{ nvidia_ctk_version.stdout }}"
      when: nvidia_ctk_version.rc == 0

    - name: Check current NVIDIA driver version
      ansible.builtin.command: nvidia-smi --query-gpu=driver_version --format=csv,noheader
      register: current_driver_version
      failed_when: false
      changed_when: false

    - name: Display current driver version
      ansible.builtin.debug:
        msg: "Current NVIDIA driver version: {{ current_driver_version.stdout | default('Not available') }}"

    - name: Check if nvidia-smi works after upgrade
      ansible.builtin.command: nvidia-smi
      register: nvidia_smi_check_post_upgrade
      failed_when: false
      changed_when: false

    - name: Determine if reboot is needed
      ansible.builtin.set_fact:
        reboot_needed: >-
          {{ nvidia_upgrade_result is changed or 
             nvidia_smi_check_post_upgrade.rc != 0 or
             current_driver_version.stdout is version('580', '<') }}

    - name: Reboot to load updated NVIDIA drivers (if needed)
      ansible.builtin.reboot:
        msg: "Rebooting to load updated NVIDIA drivers"
        connect_timeout: 5
        reboot_timeout: 600
        pre_reboot_delay: 0
        post_reboot_delay: 30
        test_command: uptime
      when: reboot_needed | bool

    - name: Verify NVIDIA driver installation and CUDA support
      ansible.builtin.command: nvidia-smi
      register: nvidia_smi_final
      failed_when: false
      changed_when: false

    - name: Display NVIDIA driver and CUDA information
      ansible.builtin.debug:
        msg: "{{ nvidia_smi_final.stdout_lines[:5] }}"
      when: nvidia_smi_final.rc == 0

    - name: Ensure Docker service is started
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: yes

    - name: Wait for Docker daemon to be ready
      ansible.builtin.command: docker info
      register: docker_info_check
      retries: 5
      delay: 2
      until: docker_info_check.rc == 0

    - name: Test NVIDIA Container Runtime with CUDA 12.6
      ansible.builtin.command: >
        docker run --rm --runtime=nvidia --gpus all
        nvidia/cuda:12.6-base-ubuntu22.04 nvidia-smi --query-gpu=name,driver_version,cuda_version --format=csv
      register: nvidia_container_test
      failed_when: false
      changed_when: false

    - name: Display container GPU test results
      ansible.builtin.debug:
        msg: "âœ… Container GPU test successful: {{ nvidia_container_test.stdout_lines }}"
      when: nvidia_container_test.rc == 0

    - name: Display container GPU test failure (if any)
      ansible.builtin.debug:
        msg: "âŒ Container GPU test failed: {{ nvidia_container_test.stderr }}"
      when: nvidia_container_test.rc != 0

    - name: Verify final setup summary
      ansible.builtin.debug:
        msg: |
          ğŸš€ NVIDIA Setup Complete:
          - Driver: {{ current_driver_version.stdout | default('Unknown') }}
          - Container Toolkit: {{ nvidia_ctk_version.stdout | default('Unknown') }}
          - Container GPU: {{ 'Working' if nvidia_container_test.rc == 0 else 'Failed' }}
          - Ready for llamacpp GPU acceleration: {{ 'Yes' if nvidia_container_test.rc == 0 else 'No' }}


  handlers:
  - name: restart docker
    ansible.builtin.systemd:
      daemon_reload: yes
      name: docker
      state: restarted
