- name: Install Docker on Ubuntu
  hosts: all
  become: yes
  vars:
    docker_keyring_path: /etc/apt/keyrings/docker.asc

  tasks:
  - name: Install prerequisite packages
    apt:
      name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - software-properties-common
      state: present
      update_cache: yes

  - name: Ensure /etc/docker directory exists
    file:
      path: /etc/docker
      state: directory
      mode: '0755'

  - name: Ensure /etc/apt/keyrings directory exists
    file:
      path: /etc/apt/keyrings
      state: directory
      mode: '0755'

  - name: Add Docker APT key directly (replacing deprecated apt_key)
    ansible.builtin.get_url:
      url: https://download.docker.com/linux/debian/gpg
      dest: "{{ docker_keyring_path }}"
      mode: '0644'

  - name: Add Docker repository
    apt_repository:
      repo: "deb [signed-by={{ docker_keyring_path }}] https://download.docker.com/linux/debian {{ ansible_lsb.codename }} stable"
      state: present
      filename: docker

  - name: Update APT cache
    apt:
      update_cache: yes

  - name: Install Docker packages
    apt:
      name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      state: present

  - name: Ensure docker group exists
    ansible.builtin.group:
      name: docker
      state: present

  - name: Add debian and media users to docker group
    ansible.builtin.user:
      name: "{{ item }}"
      groups: docker
      append: yes
    with_items:
    - debian
    - media

  - name: Ensure Docker daemon.json is configured correctly
    ansible.builtin.template:
      src: files/docker/daemon.json.j2
      dest: /etc/docker/daemon.json
      owner: root
      group: root
      mode: '0644'

  - name: Install jq package
    ansible.builtin.apt:
      name: jq
      state: present
      update_cache: yes

  - name: Format Docker daemon.json using jq and write it back to /etc/docker/daemon.json
    ansible.builtin.command:
      cmd: jq . /etc/docker/daemon.json
    register: formatted_json
    changed_when: false

  - name: Overwrite /etc/docker/daemon.json with formatted version
    ansible.builtin.copy:
      content: "{{ formatted_json.stdout }}"
      dest: /etc/docker/daemon.json
      owner: root
      group: root
      mode: '0644'

  - name: Ensure docker service override directory exists
    ansible.builtin.file:
      path: /etc/systemd/system/docker.service.d
      state: directory
      owner: root
      group: root
      mode: '0755'

  - name: Ensure docker service has extended timeouts (systemd override)
    ansible.builtin.copy:
      dest: /etc/systemd/system/docker.service.d/override.conf
      content: |
        [Service]
        TimeoutStartSec=600
        TimeoutStopSec=600
      owner: root
      group: root
      mode: '0644'
    notify: restart docker

  - name: Create Docker cleanup script
    ansible.builtin.copy:
      dest: /usr/local/bin/docker-cleanup
      content: |
        #!/bin/bash
        # Docker cleanup script for homelab hosts
        set -e
        echo "$(date): Starting Docker cleanup..."
        docker container prune -f --filter "until=24h" || true
        docker image prune -f || true
        docker image prune -a -f --filter "until=168h" || true
        docker volume prune -f || true
        docker builder prune -a -f --filter "until=168h" || true
        docker network prune -f || true
        echo "$(date): Docker cleanup completed"
      mode: '0755'
      owner: root
      group: root

  - name: Create systemd timer for Docker cleanup
    ansible.builtin.copy:
      dest: /etc/systemd/system/docker-cleanup.timer
      content: |
        [Unit]
        Description=Docker cleanup timer
        
        [Timer]
        OnCalendar=weekly
        Persistent=true
        
        [Install]
        WantedBy=timers.target
      mode: '0644'

  - name: Create systemd service for Docker cleanup
    ansible.builtin.copy:
      dest: /etc/systemd/system/docker-cleanup.service
      content: |
        [Unit]
        Description=Docker cleanup service
        After=docker.service
        Requires=docker.service
        
        [Service]
        Type=oneshot
        ExecStart=/usr/local/bin/docker-cleanup
        StandardOutput=journal
        StandardError=journal
        
        [Install]
        WantedBy=multi-user.target
      mode: '0644'

  - name: Enable Docker cleanup timer
    ansible.builtin.systemd:
      name: docker-cleanup.timer
      enabled: yes
      state: started
      daemon_reload: yes

  - name: Truncate large existing Docker logs
    ansible.builtin.shell: |
      for log in $(find /var/lib/docker/containers -name '*-json.log' -size +10M 2>/dev/null); do
        echo "Truncating $log ($(du -h $log | cut -f1))"
        truncate -s 0 "$log"
      done
    changed_when: true
    failed_when: false

  handlers:
  - name: restart docker
    ansible.builtin.systemd:
      daemon_reload: yes
      name: docker
      state: restarted
