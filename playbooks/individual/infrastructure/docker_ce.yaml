- name: Install Docker CE on Debian 12
  hosts: all
  become: yes
  vars_files:
    - ../../../vault/secrets.yaml
  vars:
    docker_keyring_path: /etc/apt/keyrings/docker.asc

  tasks:
  - name: Install prerequisite packages
    apt:
      name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - software-properties-common
      state: present
      update_cache: yes

  - name: Ensure /etc/docker directory exists
    file:
      path: /etc/docker
      state: directory
      mode: '0755'

  - name: Ensure /etc/apt/keyrings directory exists
    file:
      path: /etc/apt/keyrings
      state: directory
      mode: '0755'

  - name: Add Docker APT key directly (replacing deprecated apt_key)
    ansible.builtin.get_url:
      url: https://download.docker.com/linux/debian/gpg
      dest: "{{ docker_keyring_path }}"
      mode: '0644'

  - name: Add Docker repository
    apt_repository:
      repo: "deb [signed-by={{ docker_keyring_path }}] https://download.docker.com/linux/debian bookworm stable"
      state: present
      filename: docker

  - name: Update APT cache
    apt:
      update_cache: yes

  - name: Install Docker packages
    apt:
      name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-compose-plugin
      state: present

  - name: Ensure docker group exists
    ansible.builtin.group:
      name: docker
      state: present

  - name: Create media group with GID from vault
    ansible.builtin.group:
      name: media
      gid: "{{ system_users.media.gid }}"
      state: present

  - name: Create media user with UID from vault
    ansible.builtin.user:
      name: media
      uid: "{{ system_users.media.uid }}"
      group: media
      groups: docker
      shell: /bin/bash
      home: /home/media
      create_home: yes
      state: present

  - name: Add terrac user to docker group
    ansible.builtin.user:
      name: terrac
      groups: docker
      append: yes

  - name: Ensure Docker daemon.json is configured correctly
    ansible.builtin.template:
      src: ../../../files/docker/daemon.json.j2
      dest: /etc/docker/daemon.json
      owner: root
      group: root
      mode: '0644'

  - name: Install jq package
    ansible.builtin.apt:
      name: jq
      state: present
      update_cache: yes

  - name: Format Docker daemon.json using jq and write it back to /etc/docker/daemon.json
    ansible.builtin.command:
      cmd: jq . /etc/docker/daemon.json
    register: formatted_json
    changed_when: false

  - name: Overwrite /etc/docker/daemon.json with formatted version
    ansible.builtin.copy:
      content: "{{ formatted_json.stdout }}"
      dest: /etc/docker/daemon.json
      owner: root
      group: root
      mode: '0644'

  - name: Ensure docker service override directory exists
    ansible.builtin.file:
      path: /etc/systemd/system/docker.service.d
      state: directory
      owner: root
      group: root
      mode: '0755'

  - name: Ensure docker service has extended timeouts (systemd override)
    ansible.builtin.copy:
      dest: /etc/systemd/system/docker.service.d/override.conf
      content: |
        [Service]
        TimeoutStartSec=600
        TimeoutStopSec=600
      owner: root
      group: root
      mode: '0644'
    notify: restart docker

  - name: Create Docker cleanup script
    ansible.builtin.copy:
      dest: /usr/local/bin/docker-cleanup
      content: |
        #!/bin/bash
        # Docker cleanup script for homelab hosts
        set -e
        echo "$(date): Starting Docker cleanup..."
        docker container prune -f --filter "until=24h" || true
        docker image prune -f || true
        docker image prune -a -f --filter "until=168h" || true
        docker volume prune -f || true
        docker builder prune -a -f --filter "until=168h" || true
        docker network prune -f || true
        echo "$(date): Docker cleanup completed"
      mode: '0755'
      owner: root
      group: root

  - name: Create systemd timer for Docker cleanup
    ansible.builtin.copy:
      dest: /etc/systemd/system/docker-cleanup.timer
      content: |
        [Unit]
        Description=Docker cleanup timer
        
        [Timer]
        OnCalendar=weekly
        Persistent=true
        
        [Install]
        WantedBy=timers.target
      mode: '0644'

  - name: Create systemd service for Docker cleanup
    ansible.builtin.copy:
      dest: /etc/systemd/system/docker-cleanup.service
      content: |
        [Unit]
        Description=Docker cleanup service
        After=docker.service
        Requires=docker.service
        
        [Service]
        Type=oneshot
        ExecStart=/usr/local/bin/docker-cleanup
        StandardOutput=journal
        StandardError=journal
        
        [Install]
        WantedBy=multi-user.target
      mode: '0644'

  - name: Enable Docker cleanup timer
    ansible.builtin.systemd:
      name: docker-cleanup.timer
      enabled: yes
      state: started
      daemon_reload: yes

  - name: Truncate large existing Docker logs
    ansible.builtin.shell: |
      for log in $(find /var/lib/docker/containers -name '*-json.log' -size +10M 2>/dev/null); do
        echo "Truncating $log ($(du -h $log | cut -f1))"
        truncate -s 0 "$log"
      done
    changed_when: true
    failed_when: false

  # ============================================================================
  # NVIDIA GPU Support (Conditional)
  # ============================================================================

  - name: Install NVIDIA drivers and container toolkit
    when: nvidia_gpu | default(false) | bool
    block:
    - name: Get current kernel version
      ansible.builtin.command: uname -r
      register: kernel_version
      changed_when: false

    - name: Install NVIDIA driver prerequisites
      ansible.builtin.apt:
        name:
        - linux-headers-{{ kernel_version.stdout }}
        - firmware-misc-nonfree
        state: present
        update_cache: yes

    - name: Install NVIDIA driver
      ansible.builtin.apt:
        name: nvidia-driver
        state: present

    - name: Blacklist Nouveau driver
      ansible.builtin.copy:
        dest: /etc/modprobe.d/blacklist-nouveau.conf
        content: |
          blacklist nouveau
          options nouveau modeset=0
        owner: root
        group: root
        mode: '0644'

    - name: Download and install NVIDIA Container Toolkit GPG key
      ansible.builtin.shell: |
        curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | \
          gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
      args:
        creates: /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg

    - name: Add NVIDIA Container Toolkit repository
      ansible.builtin.shell: |
        curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
          sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
          tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
      args:
        creates: /etc/apt/sources.list.d/nvidia-container-toolkit.list
      register: nvidia_repo_added

    - name: Update apt cache for NVIDIA Container Toolkit
      ansible.builtin.apt:
        update_cache: yes

    - name: Install NVIDIA Container Toolkit
      ansible.builtin.apt:
        name: nvidia-container-toolkit
        state: present

    - name: Configure NVIDIA Container Runtime for Docker
      ansible.builtin.command: nvidia-ctk runtime configure --runtime=docker
      register: nvidia_runtime_config
      changed_when: nvidia_runtime_config.rc == 0
      notify: restart docker

    - name: Check if nvidia-smi already works (drivers loaded)
      ansible.builtin.command: nvidia-smi
      register: nvidia_smi_check
      failed_when: false
      changed_when: false

    - name: Reboot to load NVIDIA drivers
      ansible.builtin.reboot:
        msg: "Rebooting to load NVIDIA drivers"
        connect_timeout: 5
        reboot_timeout: 600
        pre_reboot_delay: 0
        post_reboot_delay: 30
        test_command: uptime
      when: nvidia_smi_check.rc != 0

    - name: Wait for system to become reachable after reboot
      ansible.builtin.wait_for_connection:
        connect_timeout: 20
        sleep: 5
        delay: 5
        timeout: 600
      when: nvidia_smi_check.rc != 0

    - name: Verify NVIDIA driver loaded with nvidia-smi
      ansible.builtin.command: nvidia-smi
      register: nvidia_smi_output
      retries: 10
      delay: 10
      until: nvidia_smi_output.rc == 0
      changed_when: false

    - name: Display nvidia-smi output
      ansible.builtin.debug:
        msg: "{{ nvidia_smi_output.stdout_lines }}"

    - name: Test Docker GPU access
      ansible.builtin.command: docker run --rm --gpus all nvidia/cuda:12.0.0-base-ubuntu22.04 nvidia-smi
      register: docker_gpu_test
      retries: 3
      delay: 5
      until: docker_gpu_test.rc == 0
      changed_when: false

    - name: Display Docker GPU test result
      ansible.builtin.debug:
        msg: "âœ… Docker GPU access verified! NVIDIA runtime working correctly."

  handlers:
  - name: restart docker
    ansible.builtin.systemd:
      daemon_reload: yes
      name: docker
      state: restarted
