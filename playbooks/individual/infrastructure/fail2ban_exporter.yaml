---
- name: Configure fail2ban-exporter systemd service
  hosts: all
  become: true
  gather_facts: true

  vars:
    fail2ban_exporter_service: fail2ban-exporter
    fail2ban_exporter_image: registry.gitlab.com/hctrdev/fail2ban-prometheus-exporter
    fail2ban_exporter_version: latest
    fail2ban_exporter_port: 9191
    fail2ban_exporter_home: "/var/lib/services/{{ fail2ban_exporter_service }}"
    fail2ban_exporter_files: "{{ playbook_dir }}/../../../files/fail2ban-exporter"
    uid: 1001  # media user
    gid: 1001  # media group

  tasks:

  - name: Check if Docker is installed
    ansible.builtin.command: which docker
    register: docker_check
    ignore_errors: yes
    changed_when: false

  - name: Check if fail2ban is installed
    ansible.builtin.command: which fail2ban-client
    register: fail2ban_check
    ignore_errors: yes
    changed_when: false

  - name: Show Docker and fail2ban availability
    ansible.builtin.debug:
      msg: 
        - "Docker is {{ 'installed' if docker_check.rc == 0 else 'NOT installed' }} on {{ inventory_hostname }}"
        - "fail2ban is {{ 'installed' if fail2ban_check.rc == 0 else 'NOT installed' }} on {{ inventory_hostname }}"

  - name: Create fail2ban-exporter Docker Compose directory
    ansible.builtin.file:
      path: "{{ fail2ban_exporter_home }}"
      state: directory
      owner: "{{ uid }}"
      group: "{{ gid }}"
      mode: '0755'
    when: docker_check.rc == 0 and fail2ban_check.rc == 0

  - name: Create fail2ban-exporter docker-compose.yml
    ansible.builtin.template:
      src: "{{ fail2ban_exporter_files }}/fail2ban-exporter-compose.yml.j2"
      dest: "{{ fail2ban_exporter_home }}/docker-compose.yml"
      owner: "{{ uid }}"
      group: "{{ gid }}"
      mode: '0644'
    when: docker_check.rc == 0 and fail2ban_check.rc == 0
    register: fail2ban_docker_compose_config

  - name: Create fail2ban-exporter environment file
    ansible.builtin.template:
      src: "{{ fail2ban_exporter_files }}/fail2ban-exporter.env.j2"
      dest: "{{ fail2ban_exporter_home }}/.env"
      owner: "{{ uid }}"
      group: "{{ gid }}"
      mode: '0600'
    when: docker_check.rc == 0 and fail2ban_check.rc == 0
    register: fail2ban_env_config

  - name: Create fail2ban-exporter README documentation
    ansible.builtin.copy:
      src: "{{ fail2ban_exporter_files }}/README.md"
      dest: "{{ fail2ban_exporter_home }}/README.md"
      owner: "{{ uid }}"
      group: "{{ gid }}"
      mode: '0644'
    when: docker_check.rc == 0 and fail2ban_check.rc == 0

  - name: Create fail2ban-exporter Docker Compose systemd service
    ansible.builtin.template:
      src: "{{ fail2ban_exporter_files }}/fail2ban-exporter.service.j2"
      dest: "/etc/systemd/system/fail2ban-exporter.service"
      mode: '0644'
    when: docker_check.rc == 0 and fail2ban_check.rc == 0
    notify:
    - Reload systemd daemon
    - Restart fail2ban-exporter service

  - name: Show fail2ban-exporter configuration status
    ansible.builtin.debug:
      msg: "fail2ban-exporter configuration files have been updated - containers will be recreated"
    when: docker_check.rc == 0 and fail2ban_check.rc == 0 and (fail2ban_docker_compose_config.changed or fail2ban_env_config.changed)

  - name: Force fail2ban-exporter container recreation when configs change
    ansible.builtin.shell: |
      cd {{ fail2ban_exporter_home }}
      echo "Recreating fail2ban-exporter containers due to configuration changes..."
      docker compose down --timeout 30
      docker compose up -d --force-recreate
      echo "fail2ban-exporter container recreation completed"
    when: docker_check.rc == 0 and fail2ban_check.rc == 0 and (fail2ban_docker_compose_config.changed or fail2ban_env_config.changed)

  - name: Start and enable fail2ban-exporter Docker Compose service
    ansible.builtin.systemd:
      name: fail2ban-exporter.service
      state: started
      enabled: true
      daemon_reload: yes
    when: docker_check.rc == 0 and fail2ban_check.rc == 0

  handlers:
  - name: Reload systemd daemon
    ansible.builtin.systemd:
      daemon_reload: yes

  - name: Restart fail2ban-exporter service
    ansible.builtin.systemd:
      name: fail2ban-exporter.service
      state: restarted
