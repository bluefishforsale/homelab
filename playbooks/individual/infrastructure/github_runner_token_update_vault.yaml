---
# Automated GitHub Runner Token Generation and Vault Update
#
# This playbook combines token generation with automatic vault update
# Eliminates manual vault editing step
#
# Prerequisites:
#   - ansible-vault password must be provided
#   - GitHub CLI (gh) authenticated OR GITHUB_TOKEN available
#
# Usage:
#   ansible-playbook github_runner_token_update_vault.yaml --ask-vault-pass

- name: Generate GitHub Runner Token and Update Vault
  hosts: localhost
  gather_facts: false
  become: false
  vars_files:
    - ../../../vault/secrets.yaml
    - ../../../inventories/github_runners/group_vars/github_runners.yml
  
  vars:
    github_api_url: "https://api.github.com"
    vault_file_path: "{{ playbook_dir }}/../../../vault/secrets.yaml"
    auto_generate_token: true
    is_github_actions: "{{ lookup('env', 'GITHUB_ACTIONS') | default('false') | bool }}"
    github_token: "{{ lookup('env', 'GITHUB_TOKEN') | default('') }}"

  tasks:
    # ========================================================================
    # STEP 1: Generate New Token
    # ========================================================================
    
    - name: Check if GitHub CLI is installed
      ansible.builtin.shell: /opt/homebrew/bin/gh --version || /usr/local/bin/gh --version || which gh
      register: gh_check
      changed_when: false
      failed_when: false

    - name: Check GitHub CLI authentication
      ansible.builtin.shell: /opt/homebrew/bin/gh auth status || /usr/local/bin/gh auth status
      register: gh_auth_status
      changed_when: false
      failed_when: false
      when: gh_check.rc == 0

    - name: Determine token generation method
      ansible.builtin.set_fact:
        can_generate: "{{ (gh_check.rc == 0 and gh_auth_status.rc == 0) or (is_github_actions and github_token | length > 0) }}"

    - name: Fail if no auth method available
      ansible.builtin.fail:
        msg: |
          Cannot generate token - no authentication method available.
          
          Options:
            1. Install and authenticate GitHub CLI: gh auth login
            2. Run in GitHub Actions with GITHUB_TOKEN
      when: not can_generate

    - name: Generate token using GitHub CLI (repo scope)
      ansible.builtin.shell: |
        if [ -x /opt/homebrew/bin/gh ]; then
          /opt/homebrew/bin/gh api --method POST -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" /repos/{{ github_repo }}/actions/runners/registration-token
        else
          /usr/local/bin/gh api --method POST -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" /repos/{{ github_repo }}/actions/runners/registration-token
        fi
      register: new_token_gh
      changed_when: false
      when:
        - can_generate
        - gh_check.rc == 0
        - gh_auth_status.rc == 0
        - github_scope == 'repo'
      no_log: false

    - name: Generate token using GitHub Actions token (repo scope)
      ansible.builtin.uri:
        url: "{{ github_api_url }}/repos/{{ github_repo }}/actions/runners/registration-token"
        method: POST
        headers:
          Authorization: "Bearer {{ github_token }}"
          Accept: "application/vnd.github+json"
          X-GitHub-Api-Version: "2022-11-28"
        status_code: [200, 201]
      register: new_token_actions
      changed_when: false
      when:
        - can_generate
        - is_github_actions
        - github_token | length > 0
        - github_scope == 'repo'
      no_log: false

    - name: Parse token from GitHub CLI
      ansible.builtin.set_fact:
        token_data: "{{ new_token_gh.stdout | from_json }}"
      when: new_token_gh is defined and new_token_gh is succeeded

    - name: Parse token from GitHub Actions
      ansible.builtin.set_fact:
        token_data: "{{ new_token_actions.json }}"
      when: 
        - new_token_actions is defined
        - new_token_actions is succeeded
        - token_data is not defined

    - name: Display generated token
      ansible.builtin.debug:
        msg: |
          ====================================================================
          ✓ NEW TOKEN GENERATED
          ====================================================================
          
          Token: {{ token_data.token }}
          Expires: {{ token_data.expires_at }}
          
          ====================================================================

    # ========================================================================
    # STEP 2: Update Vault File
    # ========================================================================

    - name: Read current vault file
      ansible.builtin.slurp:
        src: "{{ vault_file_path }}"
      register: vault_content

    - name: Decode vault content
      ansible.builtin.set_fact:
        vault_yaml: "{{ vault_content.content | b64decode | from_yaml }}"

    - name: Update token in vault data structure
      ansible.builtin.set_fact:
        updated_vault: >-
          {{ vault_yaml | combine({
            'development': vault_yaml.development | combine({
              'github': vault_yaml.development.github | default({}) | combine({
                'vault_github_registration_token': token_data.token
              })
            })
          }, recursive=True) }}

    - name: Write updated vault file
      ansible.builtin.copy:
        content: "{{ updated_vault | to_nice_yaml(indent=2) }}"
        dest: "{{ vault_file_path }}"
        mode: '0600'
        backup: yes

    - name: Re-encrypt vault file
      ansible.builtin.command:
        cmd: ansible-vault encrypt {{ vault_file_path }}
      when: vault_content.content is defined
      ignore_errors: yes

    # ========================================================================
    # STEP 3: Summary
    # ========================================================================

    - name: Display success message
      ansible.builtin.debug:
        msg: |
          ====================================================================
          ✓✓✓ SUCCESS ✓✓✓
          ====================================================================
          
          Token generated and vault updated successfully!
          
          Token: {{ token_data.token }}
          Expires: {{ token_data.expires_at }}
          
          Vault file: {{ vault_file_path }}
          Backup created: {{ vault_file_path }}.{{ ansible_date_time.epoch }}~
          
          Next step - Deploy runners:
            ansible-playbook -i inventories/github_runners/hosts.ini \
              playbooks/individual/infrastructure/github_docker_runners.yaml \
              --ask-vault-pass
          
          ====================================================================
