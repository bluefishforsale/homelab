---
- name: Configure ComfyUI with CUDA support using Docker Compose
  hosts: ocean
  become: true
  gather_facts: true

  vars_files:
    - ../../../../vars/vars_comfyui_models.yaml
    - ../../../../vars/vars_service_ports.yaml

  vars:
    service: comfyui
    image: yanwk/comfyui-boot
    version: cu126-slim
    port: "{{ service_ports.comfyui.port }}"
    data: /data01
    files: ../../../../files/comfyui
    home: "{{ data }}/services/{{ service }}"
    user: media
    uid: 1001
    gid: 1001

  tasks:

  - name: Ensure base directory exists
    ansible.builtin.file:
      path: "{{ home }}"
      state: directory
      owner: "{{ user }}"
      group: "{{ user }}"
      mode: '0755'

  - name: Ensure ComfyUI subdirectories exist
    ansible.builtin.file:
      path: "{{ home }}/{{ item }}"
      state: directory
      owner: "{{ user }}"
      group: "{{ user }}"
      mode: '0755'
    with_items:
    - ComfyUI
    - ComfyUI/input
    - ComfyUI/output
    - ComfyUI/custom_nodes
    - .cache
    - .local

  - name: Ensure model type directories exist
    ansible.builtin.file:
      path: "{{ home }}/ComfyUI/models/{{ item }}"
      state: directory
      owner: "{{ user }}"
      group: "{{ user }}"
      mode: '0755'
    with_items: "{{ comfyui_model_types }}"

  - name: Fix permissions on existing model subdirectories
    ansible.builtin.shell: |
      echo "Fixing directory permissions in {{ home }}/ComfyUI/models..."
      find "{{ home }}/ComfyUI/models" -type d -exec chmod 755 {} \;
      find "{{ home }}/ComfyUI/models" -type d -exec chown {{ user }}:{{ user }} {} \;
      DIR_COUNT=$(find "{{ home }}/ComfyUI/models" -type d | wc -l)
      echo "Fixed permissions on $DIR_COUNT directories (755, {{ user }}:{{ user }})"
    register: fix_perms_result
    changed_when: true
    tags: models

  - name: Report permission fixes
    ansible.builtin.debug:
      msg: "{{ fix_perms_result.stdout_lines | join('\n') }}"
    when: fix_perms_result is defined
    tags: models

  - name: Create docker-compose.yml
    ansible.builtin.template:
      src: "{{ files }}/docker-compose.yml.j2"
      dest: "{{ home }}/docker-compose.yml"
      owner: "{{ user }}"
      group: "{{ user }}"
      mode: '0644'
    notify:
    - Reload systemd daemon
    - Restart comfyui service

  - name: Create comfyui environment file
    ansible.builtin.template:
      src: "{{ files }}/comfyui.env.j2"
      dest: "{{ home }}/.env"
      owner: "{{ user }}"
      group: "{{ user }}"
      mode: '0600'
    notify:
    - Reload systemd daemon
    - Restart comfyui service

  - name: Create comfyui systemd service
    ansible.builtin.template:
      src: "{{ files }}/{{ item }}.j2"
      dest: "/etc/systemd/system/{{ item }}"
      mode: '0644'
    with_items:
    - comfyui.service
    notify:
    - Reload systemd daemon
    - Restart comfyui service

  - name: Download ComfyUI models with curl
    ansible.builtin.shell: |
      MODEL_PATH="{{ home }}/ComfyUI/models/{{ item.0.key }}/{{ item.1.name }}"
      
      echo "DEBUG: Checking model path: $MODEL_PATH"
      echo "DEBUG: File exists check: $(test -f "$MODEL_PATH" && echo "EXISTS" || echo "NOT_FOUND")"
      echo "DEBUG: File size check: $(test -s "$MODEL_PATH" && echo "HAS_SIZE" || echo "EMPTY_OR_MISSING")"
      if [[ -f "$MODEL_PATH" ]]; then
        echo "DEBUG: Actual file size: $(ls -lh "$MODEL_PATH" | awk '{print $5}')"
      fi
      
      # Check if file already exists and has size > 0
      if [[ -f "$MODEL_PATH" && -s "$MODEL_PATH" ]]; then
        MODEL_SIZE=$(du -h "$MODEL_PATH" | cut -f1)
        echo "ALREADY_EXISTS (${MODEL_SIZE})"
        exit 0
      fi
      
      echo "DEBUG: File not found or empty, downloading..."
      
      # Create directory structure with proper permissions
      mkdir -p "$(dirname "$MODEL_PATH")" && \
      chown {{ user }}:{{ user }} "$(dirname "$MODEL_PATH")" && \
      chmod 755 "$(dirname "$MODEL_PATH")" && \
      
      # Download with curl
      curl -f -L  \
           -w "HTTP_STATUS:%{http_code}" \
           -o "$MODEL_PATH.tmp" \
           "{{ item.1.url }}" && \
      mv "$MODEL_PATH.tmp" "$MODEL_PATH" && \
      chown {{ user }}:{{ user }} "$MODEL_PATH" && \
      chmod 644 "$MODEL_PATH" && \
      echo "DOWNLOADED" || \
      (rm -f "$MODEL_PATH.tmp" && echo "FAILED" && exit 1)
    with_subelements:
      - "{{ comfyui_models | dict2items }}"
      - value
    register: model_downloads
    failed_when: false
    ignore_errors: true
    tags: models

  - name: Debug model download raw results
    ansible.builtin.debug:
      var: model_downloads
    tags: [models, debug]
    when: false  # Enable by setting to true for debugging

  - name: Report model download results
    ansible.builtin.debug:
      msg: |
        Model Download Summary:
        {% if model_downloads is defined and model_downloads.results is defined %}
        {% for result in model_downloads.results %}
        - {{ result.item.0.key }}/{{ result.item.1.name }}: 
          Status: {{ result.stdout | default('UNKNOWN') }}
          {% if result.stdout_lines is defined and result.stdout_lines | length > 0 %}Debug: {{ result.stdout_lines | join(' | ') }}{% endif %}
          {% if result.rc != 0 and result.stderr %}Error: {{ result.stderr }}{% endif %}
        {% endfor %}
        {% else %}
        No model downloads were processed.
        {% endif %}
    tags: models

  - name: List failed model downloads
    ansible.builtin.debug:
      msg: |
        Failed Downloads (these will need manual attention):
        {% if model_downloads is defined and model_downloads.results is defined %}
        {% for result in model_downloads.results %}
        {% if result.rc != 0 or result.stdout == 'FAILED' %}
        - {{ result.item.0.key }}/{{ result.item.1.name }}
          URL: {{ result.item.1.url }}
          Exit Code: {{ result.rc }}
          {% if result.stderr %}Error: {{ result.stderr }}{% endif %}
          {% if result.stdout %}Output: {{ result.stdout }}{% endif %}
        {% endif %}
        {% endfor %}
        {% else %}
        No failed downloads to report.
        {% endif %}
    when: model_downloads is defined and model_downloads.results is defined and model_downloads.results | selectattr('rc', 'ne', 0) | list | length > 0
    tags: models

  - name: Ensure destination directories exist for model symlinks
    ansible.builtin.file:
      path: "{{ item.dest | dirname }}"
      state: directory
      owner: "{{ user }}"
      group: "{{ user }}"
      mode: '0755'
    with_items: "{{ comfyui_model_symlinks | default([]) }}"
    when: comfyui_model_symlinks is defined
    tags: models

  - name: Create model symlinks to avoid duplicate downloads
    ansible.builtin.file:
      src: "{{ item.src }}"
      dest: "{{ item.dest }}"
      owner: "{{ user }}"
      group: "{{ user }}"
      state: link
      force: yes  # Replace existing symlinks if needed
    with_items: "{{ comfyui_model_symlinks | default([]) }}"
    when: comfyui_model_symlinks is defined
    register: model_symlink_results
    tags: models

  - name: Report model symlink results
    ansible.builtin.debug:
      msg: |
        Model Symlink Summary:
        {% for result in model_symlink_results.results | default([]) %}
        - {{ result.item.src | basename }} â†’ {{ result.dest | default('N/A') }}: {% if result.changed %}LINKED{% else %}ALREADY_EXISTS{% endif %}
        {% endfor %}
    when: comfyui_model_symlinks is defined and model_symlink_results is defined
    tags: models

  - name: Enable comfyui service
    ansible.builtin.systemd:
      name: comfyui.service
      enabled: yes
      daemon_reload: yes

  handlers:
  - name: Reload systemd daemon
    ansible.builtin.systemd:
      daemon_reload: yes

  - name: Restart comfyui service
    ansible.builtin.systemd:
      name: comfyui.service
      state: restarted
