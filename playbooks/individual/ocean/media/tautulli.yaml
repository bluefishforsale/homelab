---
- name: Configure Tautulli Plex Statistics and Monitoring using Docker Compose
  hosts: ocean
  become: true
  gather_facts: true

  vars_files:
    - ../../../../vault/secrets.yaml
    - ../../../../vars/vars_service_ports.yaml

  vars:
    service: tautulli
    image: linuxserver/tautulli
    version: latest
    tautulli_port: "{{ service_ports.tautulli.port }}"
    tautulli_api_key: "{{ media_services.tautulli.api_key }}"
    exporter_service: tautulli-exporter
    exporter_image: nwalke/tautulli_exporter
    exporter_version: latest
    exporter_port: "{{ service_ports.tautulli_exporter.port }}"
    data: /data01
    files: ../../../../files/tautulli-compose
    incoming: "{{ data }}/incoming"
    complete: "{{ data }}/complete"
    home: "{{ data }}/services/{{ service }}"
    plex_logs: "{{ data }}/services/plex/Library/Application Support/Plex Media Server/Logs"
    user: media
    uid: "{{ system_users.media.uid }}"
    gid: "{{ system_users.media.gid }}"

  tasks:

  - name: Ensure base directory exists
    ansible.builtin.file:
      path: "{{ home }}"
      state: directory
      owner: "{{ uid }}"
      group: "{{ gid }}"
      mode: '0755'

  - name: Ensure config subdirectory exists
    ansible.builtin.file:
      path: "{{ home }}/config"
      state: directory
      owner: "{{ uid }}"
      group: "{{ gid }}"
      mode: '0755'

  - name: Create Tautulli config.ini with Plex connection
    ansible.builtin.template:
      src: "{{ files }}/config.ini.j2"
      dest: "{{ home }}/config/config.ini"
      owner: "{{ uid }}"
      group: "{{ gid }}"
      mode: '0644'
      force: yes
    register: tautulli_config

  - name: Create docker-compose.yml
    ansible.builtin.template:
      src: "{{ files }}/docker-compose.yml.j2"
      dest: "{{ home }}/docker-compose.yml"
      owner: "{{ uid }}"
      group: "{{ gid }}"
      mode: '0644'
    register: docker_compose_config

  - name: Create tautulli environment file
    ansible.builtin.template:
      src: "{{ files }}/tautulli.env.j2"
      dest: "{{ home }}/.env"
      owner: "{{ uid }}"
      group: "{{ gid }}"
      mode: '0600'
    register: tautulli_env

  - name: Show what configuration files changed
    ansible.builtin.debug:
      msg: "Configuration files have been updated - containers will be recreated"
    when: docker_compose_config.changed or tautulli_env.changed or tautulli_config.changed

  - name: Stop and remove old systemd services if they exist
    ansible.builtin.systemd:
      name: "{{ item }}"
      state: stopped
      enabled: no
    ignore_errors: yes
    with_items:
    - tautulli.service
    - tautulli-exporter.service

  - name: Remove old systemd service files
    ansible.builtin.file:
      path: "/etc/systemd/system/{{ item }}"
      state: absent
    with_items:
    - tautulli.service
    - tautulli-exporter.service

  - name: Create tautulli-compose systemd service
    ansible.builtin.template:
      src: "{{ files }}/tautulli-compose.service.j2"
      dest: "/etc/systemd/system/tautulli.service"
      mode: '0644'
    notify:
    - Reload systemd daemon
    - Restart tautulli service
  
  - name: Enable tautulli service
    ansible.builtin.systemd:
      name: tautulli.service
      enabled: yes
      daemon_reload: yes

  - name: Recreate containers if config changed
    ansible.builtin.shell: |
      cd {{ home }}
      echo "Recreating containers due to configuration changes..."
      docker compose down --timeout 30
      docker compose up -d --force-recreate
      echo "Container recreation completed"
    when: docker_compose_config.changed or tautulli_env.changed or tautulli_config.changed

  - name: Wait for Tautulli to be ready after config change
    ansible.builtin.wait_for:
      host: "{{ ansible_default_ipv4.address }}"
      port: "{{ tautulli_port }}"
      delay: 5
      timeout: 60
    when: docker_compose_config.changed or tautulli_env.changed or tautulli_config.changed

  - name: Restart Tautulli container to reload config properly
    ansible.builtin.shell: |
      cd {{ home }}
      docker compose restart tautulli
      echo "Tautulli restarted to apply Plex server configuration"
    when: tautulli_config.changed

  - name: Wait for Tautulli to fully initialize and write its config
    ansible.builtin.pause:
      seconds: 10
    when: tautulli_config.changed

  - name: Stop Tautulli before config rewrite
    ansible.builtin.shell: |
      cd {{ home }}
      docker compose stop tautulli
      echo "Tautulli stopped for config rewrite"
    when: tautulli_config.changed

  - name: Rewrite config.ini to override Tautulli defaults
    ansible.builtin.template:
      src: "{{ files }}/config.ini.j2"
      dest: "{{ home }}/config/config.ini"
      owner: "{{ uid }}"
      group: "{{ gid }}"
      mode: '0644'
      force: yes
    when: tautulli_config.changed

  - name: Start Tautulli with corrected configuration
    ansible.builtin.shell: |
      cd {{ home }}
      docker compose start tautulli
      echo "Tautulli started with correct Plex configuration"
    when: tautulli_config.changed

  handlers:
  - name: Reload systemd daemon
    ansible.builtin.systemd:
      daemon_reload: yes

  - name: Restart tautulli service
    ansible.builtin.systemd:
      name: tautulli.service
      state: restarted
