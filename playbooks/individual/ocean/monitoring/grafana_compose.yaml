---
- name: Configure Grafana Monitoring Dashboard using Docker Compose
  hosts: ocean
  become: true
  gather_facts: true

  vars_files:
    - ../../../../vault/secrets.yaml
    - ../../../../vars/vars_service_ports.yaml

  vars:
    service: grafana
    image: grafana/grafana
    version: 11.5.4
    port_int: 3000
    port_ext: "{{ service_ports.grafana.port }}"
    plugins: "marcusolsson-treemap-panel 2.0.0"
    data: /data01
    files: ../../../../files/grafana-compose
    home: "{{ data }}/services/{{ service }}"
    user: grafana
    uid: "{{ system_users.media.uid }}"
    gid: "{{ system_users.media.gid }}"

  tasks:

  - name: Ensure base directory exists
    ansible.builtin.file:
      path: "{{ home }}"
      state: directory
      owner: "{{ uid }}"
      group: "{{ gid }}"
      mode: '0755'

  - name: Ensure grafana and mysql subdirectories exist
    ansible.builtin.file:
      path: "{{ home }}/{{ item }}"
      state: directory
      owner: "{{ uid }}"
      group: "{{ gid }}"
      mode: '0755'
    with_items:
    - logs
    - plugins
    - data
    - mysql-data
    - mysql-logs
    - mysql-conf
    - provisioning
    - provisioning/users
    - provisioning/datasources

  - name: Check if MySQL database is already initialized
    ansible.builtin.find:
      paths: "{{ home }}/mysql-data"
      file_type: any
    register: mysql_data_contents

  - name: Show MySQL initialization status
    ansible.builtin.debug:
      msg: "MySQL data directory contains {{ mysql_data_contents.matched }} files"

  - name: Ensure all directories have correct ownership for containers
    ansible.builtin.file:
      path: "{{ home }}/{{ item }}"
      state: directory
      owner: "{{ uid }}"
      group: "{{ gid }}"
      mode: '0755'
      recurse: yes
    with_items:
    - data
    - plugins
    - logs
    - mysql-data
    - mysql-logs

  - name: Create MySQL initialization script from template
    ansible.builtin.template:
      src: "{{ files }}/mysql-init.sql.j2"
      dest: "{{ home }}/mysql-init.sql"
      owner: "{{ uid }}"
      group: "{{ gid }}"
      mode: '0644'
    register: mysql_init_script

  - name: Create MySQL configuration from template
    ansible.builtin.template:
      src: "{{ files }}/mysql-custom.cnf.j2"
      dest: "{{ home }}/mysql-conf/custom.cnf"
      owner: "{{ uid }}"
      group: "{{ gid }}"
      mode: '0644'
    register: mysql_config

  - name: Create Grafana user provisioning configuration
    ansible.builtin.template:
      src: "{{ files }}/users.yml.j2"
      dest: "{{ home }}/provisioning/users/users.yml"
      owner: "{{ uid }}"
      group: "{{ gid }}"
      mode: '0644'
    register: grafana_users_config

  - name: Create Loki datasource provisioning configuration
    ansible.builtin.copy:
      dest: "{{ home }}/provisioning/datasources/loki.yml"
      content: |
        apiVersion: 1
        
        datasources:
          - name: Loki
            type: loki
            access: proxy
            url: http://192.168.1.143:3100
            jsonData:
              maxLines: 1000
              derivedFields:
                - datasourceUid: loki
                  matcherRegex: "traceID=(\\w+)"
                  name: TraceID
                  url: "$${__value.raw}"
            isDefault: false
            editable: true
      owner: "{{ uid }}"
      group: "{{ gid }}"
      mode: '0644'
    register: grafana_loki_datasource

  - name: Create grafana configuration file with integrated MySQL
    ansible.builtin.template:
      src: "{{ files }}/grafana-mysql-container.ini.j2"
      dest: "{{ home }}/grafana.ini"
      owner: "{{ uid }}"
      group: "{{ gid }}"
      mode: '0644'
    register: grafana_config

  - name: Create docker-compose.yml
    ansible.builtin.template:
      src: "{{ files }}/docker-compose.yml.j2"
      dest: "{{ home }}/docker-compose.yml"
      owner: "{{ uid }}"
      group: "{{ gid }}"
      mode: '0644'
    register: docker_compose_config

  - name: Create grafana environment file
    ansible.builtin.template:
      src: "{{ files }}/grafana.env.j2"
      dest: "{{ home }}/.env"
      owner: "{{ uid }}"
      group: "{{ gid }}"
      mode: '0600'
    register: grafana_env

  - name: Show what configuration files changed
    ansible.builtin.debug:
      msg: "Configuration files have been updated - containers will be recreated"
    when: mysql_init_script.changed or mysql_config.changed or grafana_config.changed or docker_compose_config.changed or grafana_env.changed or grafana_users_config.changed or grafana_loki_datasource.changed

  - name: Create grafana systemd service
    ansible.builtin.template:
      src: "{{ files }}/grafana.service.j2"
      dest: "/etc/systemd/system/grafana.service"
      mode: '0644'
    notify:
    - Reload systemd daemon
    - Restart grafana service
  
  - name: Enable grafana service
    ansible.builtin.systemd:
      name: grafana.service
      enabled: yes
      daemon_reload: yes

  - name: Recreate containers if config changed
    ansible.builtin.shell: |
      cd {{ home }}
      echo "Recreating containers due to configuration changes..."
      docker compose down --timeout 30
      docker compose up -d --force-recreate
      echo "Container recreation completed"
    when: mysql_init_script.changed or mysql_config.changed or grafana_config.changed or docker_compose_config.changed or grafana_env.changed or grafana_users_config.changed or grafana_loki_datasource.changed

  handlers:
  - name: Reload systemd daemon
    ansible.builtin.systemd:
      daemon_reload: yes

  - name: Restart grafana service
    ansible.builtin.systemd:
      name: grafana.service
      state: restarted
