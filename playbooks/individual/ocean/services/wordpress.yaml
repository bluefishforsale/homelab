---
- name: Configure WordPress blog platform with Docker Compose
  hosts: ocean
  become: true
  gather_facts: true

  vars_files:
    - ../../../../vault/secrets.yaml

  vars:
    service: wordpress
    image: wordpress
    version: latest
    port_ext: 8085
    port_int: 80
    data: /data01
    files: ../../../../files/wordpress
    home: "{{ data }}/services/{{ service }}"
    user: media
    uid: 1001
    gid: 1001

  tasks:

  - name: Ensure base directory exists
    ansible.builtin.file:
      path: "{{ home }}"
      state: directory
      owner: "{{ user }}"
      group: "{{ user }}"
      mode: '0755'

  - name: Ensure WordPress subdirectories exist
    ansible.builtin.file:
      path: "{{ home }}/{{ item }}"
      state: directory
      owner: "{{ user }}"
      group: "{{ user }}"
      mode: '0755'
    with_items:
    - wp-content
    - wp-content/themes
    - wp-content/plugins
    - wp-content/uploads
    - mysql-data
    - mysql-logs
    - mysql-conf

  - name: Ensure media user Docker config directory exists
    ansible.builtin.file:
      path: "/home/{{ user }}/.docker"
      state: directory
      owner: "{{ user }}"
      group: "{{ user }}"
      mode: '0755'

  - name: Create empty Docker config if it doesn't exist
    ansible.builtin.copy:
      content: '{}'
      dest: "/home/{{ user }}/.docker/config.json"
      owner: "{{ user }}"
      group: "{{ user }}"
      mode: '0644'
      force: no

  - name: Check if MySQL database is already initialized
    ansible.builtin.find:
      paths: "{{ home }}/mysql-data"
      file_type: any
    register: mysql_data_contents

  - name: Show MySQL initialization status
    ansible.builtin.debug:
      msg: "MySQL data directory contains {{ mysql_data_contents.matched }} files"

  - name: Ensure MySQL directories have correct ownership
    ansible.builtin.file:
      path: "{{ home }}/{{ item }}"
      state: directory
      owner: "{{ user }}"
      group: "{{ user }}"
      mode: '0755'
      recurse: yes
    with_items:
    - mysql-data
    - mysql-logs

  - name: Set wp-content ownership to www-data (WordPress container user)
    ansible.builtin.file:
      path: "{{ home }}/wp-content"
      state: directory
      owner: "33"
      group: "33"
      mode: '0755'
      recurse: yes

  - name: Create MySQL configuration from template
    ansible.builtin.template:
      src: "{{ files }}/mysql-custom.cnf.j2"
      dest: "{{ home }}/mysql-conf/custom.cnf"
      owner: "{{ user }}"
      group: "{{ user }}"
      mode: '0644'
    register: mysql_config

  - name: Create PHP upload configuration for large videos
    ansible.builtin.template:
      src: "{{ files }}/uploads.ini.j2"
      dest: "{{ home }}/uploads.ini"
      owner: "{{ user }}"
      group: "{{ user }}"
      mode: '0644'
    register: php_config

  - name: Create docker-compose.yml
    ansible.builtin.template:
      src: "{{ files }}/docker-compose.yml.j2"
      dest: "{{ home }}/docker-compose.yml"
      owner: "{{ user }}"
      group: "{{ user }}"
      mode: '0644'
    register: docker_compose_config

  - name: Create WordPress environment file
    ansible.builtin.template:
      src: "{{ files }}/wordpress.env.j2"
      dest: "{{ home }}/.env"
      owner: "{{ user }}"
      group: "{{ user }}"
      mode: '0600'
    register: wordpress_env

  - name: Fix ownership of config files for media user
    ansible.builtin.file:
      path: "{{ home }}/{{ item }}"
      owner: "{{ user }}"
      group: "{{ user }}"
    with_items:
    - docker-compose.yml
    - .env
    - mysql-conf

  - name: Show what configuration files changed
    ansible.builtin.debug:
      msg: "Configuration files have been updated - containers will be recreated"
    when: mysql_config.changed or php_config.changed or docker_compose_config.changed or wordpress_env.changed

  - name: Recreate containers if config changed
    ansible.builtin.shell: |
      cd {{ home }}
      echo "Recreating containers due to configuration changes..."
      /usr/bin/docker compose -f docker-compose.yml down --timeout 30
      /usr/bin/docker compose -f docker-compose.yml up -d --force-recreate
      echo "Container recreation completed"
    when: mysql_config.changed or docker_compose_config.changed or wordpress_env.changed
    become_user: "{{ user }}"
    environment:
      DOCKER_CONFIG: "/home/{{ user }}/.docker"
    tags: [recreate]

  - name: Force container recreation (manual override)
    ansible.builtin.shell: |
      cd {{ home }}
      /usr/bin/docker compose -f docker-compose.yml down --timeout 30
      /usr/bin/docker compose -f docker-compose.yml up -d --force-recreate
    become_user: "{{ user }}"
    environment:
      DOCKER_CONFIG: "/home/{{ user }}/.docker"
    tags: [never, force_recreate]

  - name: Create wordpress systemd service
    ansible.builtin.template:
      src: "{{ files }}/wordpress.service.j2"
      dest: "/etc/systemd/system/wordpress.service"
      mode: '0644'
    notify:
    - Reload systemd daemon
  
  - name: Enable wordpress service
    ansible.builtin.systemd:
      name: wordpress.service
      enabled: yes
      daemon_reload: yes

  - name: Start WordPress service if not running
    ansible.builtin.systemd:
      name: wordpress.service
      state: started

  handlers:
  - name: Reload systemd daemon
    ansible.builtin.systemd:
      daemon_reload: yes
